<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <title>Skibidi TD — Value List + Calculator (final)</title>
  <style>
    :root{
      --bg:#000;
      --card:#0f0f0f;
      --box:#151515;
      --border:#2f2f2f;
      --muted:#8a8a8a;
      --gold:#facc15;
      --purple:#a855f7;
      --accent-grad: linear-gradient(90deg,#8b4bff,#ff2d6f);
      --neon-red: rgba(255,50,80,0.18);
      --neon-white: rgba(255,255,255,0.12);
      --text:#ffffff;

      --grad-astral: linear-gradient(60deg, #640081, #7e00a5, #154af0, #00cd82, #11ff46);
      --grad-cosmic: linear-gradient(80deg, #b800e6, #6cedf0);
      --grad-divine: linear-gradient(180deg, #c400cf, #2248ff);
      --grad-godly: linear-gradient(180deg, #7b00e6, #6367ff);
      --grad-exclusive: linear-gradient(180deg, #2e7dff, #2be7f6);
      --grad-mythic: linear-gradient(180deg, #ff6d68, #cc1d1b);
      --grad-legendary: linear-gradient(180deg, #f5a623, #d48c00);
    }

    *{box-sizing:border-box;font-family:'Montserrat',sans-serif;-webkit-font-smoothing:antialiased;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);padding:22px}

    /* Controls */
    .controls{max-width:1200px;margin:0 auto 18px;display:flex;flex-direction:column;gap:14px}
    #search-bar{width:100%;padding:14px;border-radius:12px;background:var(--card);border:2px solid var(--border);color:var(--text);outline:none;font-size:15px}
    .tabs,.sort{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .tab-btn,.sort-btn{background:var(--card);border:2px solid var(--border);padding:10px 16px;border-radius:8px;color:var(--muted);font-weight:900;cursor:pointer;text-transform:uppercase}
    .tab-btn.active,.sort-btn.active{color:#fff;border-color:var(--gold);box-shadow:0 0 0 4px rgba(250,204,21,0.06) inset}

    /* Main list */
    .list-root{max-width:1200px;margin:22px auto;display:grid;grid-template-columns:repeat(3,1fr);gap:25px}
    .unit-card{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:12px;min-height:260px;justify-content:space-between}
    .header-section{display:flex;flex-direction:column;align-items:center;gap:6px}
    .unit-title{font-weight:900;font-size:16px;text-transform:uppercase;line-height:1.1;text-align:center;white-space:normal;word-break:normal;overflow-wrap:break-word}
    .second-edition-tag{font-size:10px;font-weight:700;color:var(--gold);text-transform:uppercase;margin-top:4px;letter-spacing:1px}
    .portrait-frame{width:120px;height:120px;border-radius:50%;margin:0 auto;border:4px solid #000;display:flex;align-items:center;justify-content:center;position:relative}
    .unit-image{width:110px;height:110px;border-radius:50%;background-size:cover;background-position:center}
    /* Rarity halo for main portraits */
    .portrait-frame.rarity-astral::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-astral);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-cosmic::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-cosmic);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-divine::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-divine);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-godly::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-godly);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-exclusive::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-exclusive);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-mythic::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-mythic);z-index:-1;opacity:0.95}
    .portrait-frame.rarity-legendary::after{content:'';position:absolute;inset:-6px;border-radius:50%;background:var(--grad-legendary);z-index:-1;opacity:0.95}

    .data-table{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .data-cell{background:var(--box);border:1px solid var(--border);padding:10px;border-radius:8px;text-align:center;min-height:56px;display:flex;flex-direction:column;justify-content:center}
    .label{color:var(--muted);font-size:11px;font-weight:900;text-transform:uppercase;margin-bottom:6px}
    .val{font-weight:900}
    .highlight-gold{color:var(--gold)}
    .highlight-purple{color:var(--purple)}

    .pagination{max-width:1200px;margin:22px auto;display:flex;gap:12px;justify-content:center;align-items:center}
    .pagination-btn{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:8px;color:var(--muted);font-weight:900}
    .page-info{color:var(--muted);font-weight:900}

    /* ---------------- Calculator styles ---------------- */
    .calculator-root{max-width:1200px;margin:0 auto 10px;display:none}
    .calc-row{display:flex;gap:28px;align-items:flex-start;justify-content:center}
    .trade-panel{
      width:46%;
      border-radius:14px;
      padding:22px;
      min-height:380px;
      display:flex;
      flex-direction:column;
      gap:16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border: 2px solid rgba(255,255,255,0.06);
      box-shadow: 0 0 28px var(--neon-white), 0 0 40px var(--neon-red) inset;
    }
    .trade-title{font-weight:900;text-transform:uppercase;text-align:center;font-size:20px;letter-spacing:1px}
    .trade-title.you{color:#ff2d6f}
    .trade-title.them{color:#6ea0ff}
    .plus-wrap{display:flex;justify-content:center}
    .plus-btn{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#7b00e6,#ff2d6f);display:grid;place-items:center;font-size:28px;font-weight:900;color:#fff;cursor:pointer;border:3px solid rgba(255,255,255,0.06);box-shadow:0 14px 40px rgba(255,0,60,0.12)}
    .controls-row{display:flex;gap:10px;align-items:center}
    select,input[type=number]{background:var(--box);border:2px solid var(--border);padding:10px;border-radius:10px;color:var(--text)}
    select.unit-select{min-width:260px}
    .add-small{background:var(--accent-grad);border-radius:8px;padding:8px 10px;border:none;cursor:pointer;color:#000;font-weight:900}

    .items-list{border-radius:10px;min-height:180px;padding:14px;border:2px solid rgba(255,255,255,0.03);display:flex;gap:12px;flex-wrap:wrap;align-content:flex-start;align-items:flex-start}
    .selected-thumb{width:76px;height:76px;border-radius:10px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,0.04);background:var(--box)}
    .thumb-img{width:100%;height:100%;background-size:cover;background-position:center}
    .thumb-remove{position:absolute;left:6px;top:6px;background:rgba(0,0,0,0.6);color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-weight:900}
    /* hide value/demand badges on squares */
    .thumb-badge, .thumb-demand{display:none}

    .total-box{display:flex;justify-content:center;margin-top:auto}
    .total-value{background:linear-gradient(90deg,#7b00e6,#ff2d6f);padding:10px 18px;border-radius:10px;color:#000;font-weight:900;box-shadow:0 10px 26px rgba(0,0,0,0.6)}

    .verdict-wrap{max-width:1200px;margin:18px auto;display:flex;justify-content:center}
    .verdict{width:520px;padding:16px;border-radius:12px;border:2px solid rgba(255,255,255,0.03);display:flex;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
    .verdict-text{font-weight:900;font-size:32px;color:#6ea0ff;letter-spacing:2px;text-transform:uppercase}

    /* ---------------- Picker modal ---------------- */
    .picker-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:9999;padding:18px}
    .picker-box{width:100%;max-width:1180px;min-height:520px;border-radius:12px;padding:12px;display:flex;gap:12px;background:linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.003));border:3px solid rgba(255,255,255,0.03);box-shadow:0 30px 80px rgba(0,0,0,0.75)}
    .picker-sidebar{width:160px;display:flex;flex-direction:column;gap:12px;padding:6px}
    .picker-cat{padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.03);color:var(--muted);font-weight:900;cursor:pointer;text-transform:uppercase}
    .picker-cat.active{color:#fff;border-color:var(--gold);box-shadow:0 0 0 4px rgba(250,204,21,0.05) inset}
    .picker-main{flex:1;display:flex;flex-direction:column;gap:10px;padding:6px}
    .picker-search input{width:100%;padding:12px;border-radius:12px;background:var(--box);border:2px solid var(--border);color:var(--text)}
    .picker-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,78px);gap:12px;overflow:auto;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:transparent}
    .picker-thumb{width:78px;height:78px;border-radius:10px;border:3px solid rgba(255,255,255,0.04);background:var(--box);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
    .picker-thumb:hover{transform:translateY(-6px);transition:transform .12s ease;box-shadow:0 8px 20px rgba(0,0,0,0.6)}
    .picker-thumb .p-badge{display:none!important} /* ensure no values on thumbs */

    .rarity-astral .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-astral);z-index:-1;opacity:0.95}
    .rarity-cosmic .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-cosmic);z-index:-1;opacity:0.95}
    .rarity-divine .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-divine);z-index:-1;opacity:0.95}
    .rarity-godly .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-godly);z-index:-1;opacity:0.95}
    .rarity-exclusive .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-exclusive);z-index:-1;opacity:0.95}
    .rarity-mythic .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-mythic);z-index:-1;opacity:0.95}
    .rarity-legendary .picker-thumb::after{content:'';position:absolute;inset:-4px;border-radius:12px;background:var(--grad-legendary);z-index:-1;opacity:0.95}

    /* show placeholder text in picker grid until category selected */
    .picker-placeholder{display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:900;font-size:14px;padding:20px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02);height:100%}

    @media(max-width:1024px){
      .list-root{grid-template-columns:repeat(2,1fr)}
      .calc-row{flex-direction:column}
      .trade-panel{width:100%}
      .picker-box{flex-direction:column;min-height:560px}
      .picker-sidebar{width:100%;display:flex;overflow:auto;gap:8px}
      .picker-grid{grid-template-columns:repeat(auto-fill,86px)}
    }
    @media(max-width:600px){
      .list-root{grid-template-columns:1fr}
      .portrait-frame{width:96px;height:96px}
      .unit-image{width:86px;height:86px}
      .picker-grid{grid-template-columns:repeat(auto-fill,86px)}
    }
  </style>
</head>
<body>
  <div class="controls">
    <input id="search-bar" placeholder="Search unit..." aria-label="Search units">
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-rarity="all">All</button>
      <button class="tab-btn" data-rarity="astral">Astral</button>
      <button class="tab-btn" data-rarity="cosmic">Cosmic</button>
      <button class="tab-btn" data-rarity="divine">Divine</button>
      <button class="tab-btn" data-rarity="godly">Godly</button>
      <button class="tab-btn" data-rarity="exclusive">Exclusive</button>
      <button class="tab-btn" data-rarity="mythic">Mythic</button>
      <button class="tab-btn" data-rarity="legendary">Legendary</button>
      <button class="tab-btn" data-rarity="calculator" id="calculator-tab">Calculator</button>
    </div>
    <div class="sort" id="sort">
      <button class="sort-btn active" data-sort="default">Default Sort</button>
      <button class="sort-btn" data-sort="value-desc">High Value</button>
    </div>
  </div>

  <!-- Calculator -->
  <div id="calculator-root" class="calculator-root" aria-hidden="true">
    <div class="calc-row">
      <div class="trade-panel" id="left-panel">
        <div class="trade-title you">YOUR VALUE</div>
        <div class="plus-wrap"><div class="plus-btn" id="plus-left" title="Open picker">+</div></div>

        <div style="display:none" aria-hidden="true">
          <div class="controls-row" role="group">
            <select id="unit-select-left" class="unit-select" aria-label="left unit select"></select>
            <select id="trait-select-left" aria-label="left trait select">
              <option value="base">Base</option>
              <option value="grandmaster">Grandmaster</option>
              <option value="master">Master</option>
              <option value="superPayday">Super Payday</option>
              <option value="sniper">Sniper</option>
            </select>
            <input id="qty-left" type="number" min="1" value="1" aria-label="left quantity" style="width:80px">
            <button class="add-small" id="add-left">Add</button>
          </div>
        </div>

        <div class="items-list" id="left-items" aria-live="polite"></div>

        <div class="total-box"><div class="total-value" id="left-total">TOTAL VALUE: 0</div></div>
      </div>

      <div class="trade-panel" id="right-panel">
        <div class="trade-title them">THEIR VALUE</div>
        <div class="plus-wrap"><div class="plus-btn" id="plus-right" title="Open picker">+</div></div>

        <div style="display:none" aria-hidden="true">
          <div class="controls-row" role="group">
            <select id="unit-select-right" class="unit-select" aria-label="right unit select"></select>
            <select id="trait-select-right" aria-label="right trait select">
              <option value="base">Base</option>
              <option value="grandmaster">Grandmaster</option>
              <option value="master">Master</option>
              <option value="superPayday">Super Payday</option>
              <option value="sniper">Sniper</option>
            </select>
            <input id="qty-right" type="number" min="1" value="1" aria-label="right quantity" style="width:80px">
            <button class="add-small" id="add-right">Add</button>
          </div>
        </div>

        <div class="items-list" id="right-items" aria-live="polite"></div>

        <div class="total-box"><div class="total-value" id="right-total">TOTAL VALUE: 0</div></div>
      </div>
    </div>
  </div>

  <div class="verdict-wrap">
    <div class="verdict" id="verdict-panel">
      <div class="verdict-text" id="verdict-text">NO ITEMS</div>
    </div>
  </div>

  <!-- Main list -->
  <div id="list-root" class="list-root" aria-live="polite"></div>

  <div class="pagination">
    <button id="prev-btn" class="pagination-btn">Previous</button>
    <div class="page-info" id="page-info">Page 1 of 1</div>
    <button id="next-btn" class="pagination-btn">Next</button>
  </div>

  <!-- Keep your data file unchanged -->
  <script src="skibidi-td-data.js"></script>

  <!-- Script: render list, calculator and picker -->
  <script>
  (function(){
    function parseValue(valString){
      if(valString === 0) return 0;
      if(!valString && valString !== 0) return 0;
      let s = String(valString).trim();
      s = s.replace(/[\$\€\£\¥\₹]/g,'').replace(/\s+/g,'');
      const m = s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/);
      if(m){
        let n = parseFloat(m[1].replace(/,/g,'')) || 0;
        const sfx = m[2];
        if(sfx){
          if(sfx.toLowerCase() === 'k') n *= 1e3;
          if(sfx.toLowerCase() === 'm') n *= 1e6;
        }
        return n;
      }
      const f = s.match(/[\d.]+/);
      return f ? parseFloat(f[0].replace(/,/g,'')) : 0;
    }
    window.parseValue = parseValue;

    function abbr(n){
      if(!isFinite(n) || n === 0) return '0';
      if(n >= 1e6) return (n/1e6).toFixed(2) + 'M+';
      if(n >= 1e3) return (n/1e3).toFixed(2) + 'K';
      return Math.round(n).toLocaleString();
    }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    const listRoot = document.getElementById('list-root');
    const searchBar = document.getElementById('search-bar');
    const tabs = document.getElementById('tabs');
    const sort = document.getElementById('sort');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    const calcRoot = document.getElementById('calculator-root');
    const leftSelect = document.getElementById('unit-select-left');
    const rightSelect = document.getElementById('unit-select-right');
    const traitLeft = document.getElementById('trait-select-left');
    const traitRight = document.getElementById('trait-select-right');
    const qtyLeft = document.getElementById('qty-left');
    const qtyRight = document.getElementById('qty-right');
    const addLeft = document.getElementById('add-left');
    const addRight = document.getElementById('add-right');
    const leftItemsEl = document.getElementById('left-items');
    const rightItemsEl = document.getElementById('right-items');
    const leftTotalEl = document.getElementById('left-total');
    const rightTotalEl = document.getElementById('right-total');
    const verdictText = document.getElementById('verdict-text');
    const plusLeft = document.getElementById('plus-left');
    const plusRight = document.getElementById('plus-right');

    let pickerOverlay = null;
    let currentFilter = 'all';
    let searchQuery = '';
    let currentSort = 'default';
    let currentPage = 1;
    const itemsPerPage = 15;
    const rarityOrder = { 'astral':1,'cosmic':2,'godly':3,'divine':4,'mythic':5,'legendary':6,'exclusive':99 };

    if(typeof unitDatabase === 'undefined'){ listRoot.innerHTML = '<div style="color:#f88">Error: unitDatabase not loaded</div>'; throw new Error('unitDatabase required'); }
    const unitKeys = Object.keys(unitDatabase).sort((a,b)=> (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||''));
    const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";

    /* render list */
    function renderList(){
      const filtered = unitKeys.filter(k=>{
        const u = unitDatabase[k];
        const r = (u.rarity||'').toLowerCase();
        const matchesRarity = currentFilter === 'all' || r === currentFilter;
        const matchesSearch = (u.name||'').toLowerCase().includes(searchQuery.toLowerCase());
        return matchesRarity && matchesSearch;
      });

      filtered.sort((a,b)=>{
        if(currentSort === 'value-desc'){ return parseValue(unitDatabase[b].baseStats.value) - parseValue(unitDatabase[a].baseStats.value); }
        const wa = rarityOrder[(unitDatabase[a].rarity||'').toLowerCase()]||999;
        const wb = rarityOrder[(unitDatabase[b].rarity||'').toLowerCase()]||999;
        if(wa !== wb) return wa - wb;
        return (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||'');
      });

      const totalPages = Math.max(1, Math.ceil(filtered.length / itemsPerPage));
      if(currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * itemsPerPage;
      const pageKeys = filtered.slice(start, start + itemsPerPage);

      pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      listRoot.innerHTML = pageKeys.map(k=>{
        const u = unitDatabase[k];
        const portrait = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
        const edition = u.secondEdition && String(u.secondEdition).toLowerCase() === 'yes' ? `<div class="second-edition-tag">2nd Edition</div>` : '';
        const rslug = (u.rarity||'').toLowerCase();
        return `<div class="unit-card" data-unit="${k}">
          <div class="header-section">
            <div class="unit-title">${escapeHtml(u.name)}</div>${edition}
          </div>
          <div style="display:flex;align-items:center;justify-content:center">
            <div class="portrait-frame rarity-${rslug}" onclick="updateUnitStats('${k}', null)" title="Reset to Base Stats">
              <div class="unit-image" style="background-image:${portrait}"></div>
            </div>
          </div>
          <div class="data-table">
            <div class="data-cell"><span class="label">Value</span><span class="val highlight-gold">${escapeHtml(u.baseStats.value)}</span></div>
            <div class="data-cell"><span class="label">Status</span><span class="val">${escapeHtml(u.baseStats.status)}</span></div>
            <div class="data-cell"><span class="label">Demand</span><span class="val highlight-purple">${escapeHtml(u.baseStats.demand)}</span></div>
          </div>
        </div>`;
      }).join('');
    }

    window.updateUnitStats = function(unitKey, traitKey){
      const unit = unitDatabase[unitKey];
      const card = document.querySelector(`[data-unit="${unitKey}"]`);
      if(!unit || !card) return;
      const stats = traitKey ? unit.traits[traitKey] : unit.baseStats;
      const valueEl = card.querySelector('.val-value');
      const demandEl = card.querySelector('.val-demand');
      const statusEl = card.querySelector('.val-status');
      if(valueEl) valueEl.innerText = stats.value;
      if(demandEl) demandEl.innerText = stats.demand;
      if(statusEl) statusEl.innerText = stats.status;
    };

    searchBar.addEventListener('input', e => { searchQuery = e.target.value || ''; currentPage = 1; renderList(); });

    tabs.addEventListener('click', e => {
      if(!e.target.classList.contains('tab-btn')) return;
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.getAttribute('data-rarity') || 'all';
      if(currentFilter === 'calculator'){
        calcRoot.style.display = 'block'; calcRoot.setAttribute('aria-hidden','false'); listRoot.style.display = 'none';
      } else {
        calcRoot.style.display = 'none'; calcRoot.setAttribute('aria-hidden','true'); listRoot.style.display = ''; currentPage = 1; renderList();
      }
    });

    sort.addEventListener('click', e => {
      if(!e.target.classList.contains('sort-btn')) return;
      sort.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      currentSort = e.target.getAttribute('data-sort') || 'default';
      currentPage = 1; renderList();
    });

    prevBtn.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderList(); window.scrollTo({top:0,behavior:'smooth'}); } });
    nextBtn.addEventListener('click', ()=> {
      const filteredTotal = unitKeys.filter(k => {
        const u = unitDatabase[k];
        return (currentFilter === 'all' || (u.rarity||'').toLowerCase()===currentFilter) && (u.name||'').toLowerCase().includes(searchQuery.toLowerCase());
      }).length;
      const maxPage = Math.ceil(filteredTotal / itemsPerPage) || 1;
      if(currentPage < maxPage){ currentPage++; renderList(); window.scrollTo({top:0,behavior:'smooth'}); }
    });

    /* Calculator + picker */
    const leftItems = [], rightItems = [];

    function populateSelects(){
      const makeOpt = key => {
        const u = unitDatabase[key];
        return `<option value="${key}">${escapeHtml(u.name)} (${u.rarity||'n/a'}) — ${u.baseStats.value||'N/A'}</option>`;
      };
      if(leftSelect) leftSelect.innerHTML = unitKeys.map(makeOpt).join('');
      if(rightSelect) rightSelect.innerHTML = unitKeys.map(makeOpt).join('');
    }

    function getUnitValue(key, trait){
      const u = unitDatabase[key];
      if(!u) return 0;
      if(trait && trait !== 'base' && u.traits && u.traits[trait]) return parseValue(u.traits[trait].value);
      return parseValue(u.baseStats.value);
    }

    function addToSide(side, key, trait, qty){
      qty = Math.max(1, Math.floor(qty) || 1);
      const single = getUnitValue(key, trait);
      const computed = single * qty;
      const id = `${key}|${trait}|${Date.now()}|${Math.random().toString(36).slice(2,6)}`;
      const entry = { id, key, trait, qty, single, computed };
      if(side === 'left') leftItems.push(entry); else rightItems.push(entry);
      renderThumbs(); updateTotalsAndVerdict();
    }

    function renderThumbs(){
      leftItemsEl.innerHTML = leftItems.length ? leftItems.map(it => thumbHTML(it,'left')).join('') : '';
      rightItemsEl.innerHTML = rightItems.length ? rightItems.map(it => thumbHTML(it,'right')).join('') : '';
      document.querySelectorAll('.thumb-remove').forEach(btn => { btn.removeEventListener('click', thumbRemoveHandler); btn.addEventListener('click', thumbRemoveHandler); });
    }

    function thumbHTML(it, side){
      const u = unitDatabase[it.key] || {};
      const portrait = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
      const r = (u.rarity || '').toLowerCase();
      return `<div class="selected-thumb rarity-${r}" data-id="${it.id}" data-side="${side}" title="${escapeHtml(u.name)}">
        <div class="thumb-img" style="background-image:${portrait}"></div>
        <div class="thumb-remove" data-id="${it.id}" data-side="${side}" aria-label="Remove">×</div>
      </div>`;
    }

    function thumbRemoveHandler(e){
      const id = e.currentTarget.getAttribute('data-id');
      const side = e.currentTarget.getAttribute('data-side');
      if(side === 'left'){ const idx = leftItems.findIndex(x => x.id === id); if(idx >= 0) leftItems.splice(idx,1); }
      else { const idx = rightItems.findIndex(x => x.id === id); if(idx >= 0) rightItems.splice(idx,1); }
      renderThumbs(); updateTotalsAndVerdict();
    }

    function sumList(list){ return list.reduce((s,it) => s + Number(it.computed||0), 0); }

    function updateTotalsAndVerdict(){
      leftItems.forEach(i => i.computed = (i.single||0) * (i.qty||1));
      rightItems.forEach(i => i.computed = (i.single||0) * (i.qty||1));
      const leftSum = sumList(leftItems);
      const rightSum = sumList(rightItems);
      leftTotalEl.innerText = `TOTAL VALUE: ${abbr(leftSum)}`;
      rightTotalEl.innerText = `TOTAL VALUE: ${abbr(rightSum)}`;

      const FAIR = 0.02, SMALL = 0.10;
      let verdict = 'NO ITEMS';
      if(leftSum === 0 && rightSum === 0) verdict = 'NO ITEMS';
      else if(Math.abs(leftSum - rightSum) <= Math.max(1, FAIR * Math.max(leftSum, rightSum))) verdict = 'FAIR';
      else if(leftSum > rightSum){
        if(rightSum === 0 || leftSum > rightSum * (1 + SMALL)) verdict = 'OVERPAYING'; else verdict = 'LOSE';
      } else {
        if(leftSum === 0 || rightSum > leftSum * (1 + SMALL)) verdict = 'UNDERPAYING'; else verdict = 'WIN';
      }
      verdictText.innerText = verdict.toUpperCase();
    }

    /* Picker (rarity only). Picker shows no thumbnails until user clicks a category. */
    function createPicker(){
      if(pickerOverlay) return;
      pickerOverlay = document.createElement('div');
      pickerOverlay.className = 'picker-overlay';
      pickerOverlay.innerHTML = `<div class="picker-box" role="dialog" aria-modal="true">
        <div class="picker-sidebar" id="picker-sidebar"></div>
        <div class="picker-main">
          <div class="picker-search"><input id="picker-search-input" placeholder="SEARCH UNITS..." aria-label="Picker search"></div>
          <div class="picker-grid" id="picker-grid"></div>
        </div>
      </div>`;
      document.body.appendChild(pickerOverlay);
      pickerOverlay.addEventListener('click', e => { if(e.target === pickerOverlay) pickerOverlay.style.display = 'none'; });

      const sidebar = pickerOverlay.querySelector('#picker-sidebar');
      const rarities = ['All','Astral','Cosmic','Divine','Godly','Exclusive','Mythic','Legendary'];
      sidebar.innerHTML = rarities.map(r => `<div class="picker-cat" data-cat="${r.toLowerCase()}">${r}</div>`).join('');
      sidebar.querySelectorAll('.picker-cat').forEach(btn => {
        btn.addEventListener('click', () => {
          sidebar.querySelectorAll('.picker-cat').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          // when category clicked, show thumbs filtered by rarity
          const cat = btn.getAttribute('data-cat');
          renderPickerGrid(currentPickerSide, currentPickerTrait, currentPickerQty, cat, pickerOverlay.querySelector('#picker-search-input').value || '');
        });
      });
      // placeholder in picker-grid until category chosen
      const grid = pickerOverlay.querySelector('#picker-grid');
      grid.innerHTML = `<div class="picker-placeholder">Choose a category on the left to view units</div>`;

      const searchInput = pickerOverlay.querySelector('#picker-search-input');
      searchInput.addEventListener('input', e => {
        const active = sidebar.querySelector('.picker-cat.active');
        if(!active) return; // nothing to do until category chosen
        renderPickerGrid(currentPickerSide, currentPickerTrait, currentPickerQty, active.getAttribute('data-cat'), e.target.value || '');
      });
    }

    let currentPickerSide = 'left', currentPickerTrait = 'base', currentPickerQty = 1;

    function openPicker(side, trait, qty){
      currentPickerSide = side;
      currentPickerTrait = trait || 'base';
      currentPickerQty = Math.max(1, Math.floor(qty) || 1);
      createPicker();
      pickerOverlay.style.display = 'flex';
      // ensure no thumbnails show until a category is clicked
      const grid = pickerOverlay.querySelector('#picker-grid');
      grid.innerHTML = `<div class="picker-placeholder">Choose a category on the left to view units</div>`;
      pickerOverlay.querySelector('#picker-search-input').value = '';
      setTimeout(()=>{ const s = pickerOverlay.querySelector('#picker-search-input'); if(s) s.focus(); },120);
    }

    function renderPickerGrid(side, trait, qty, category, q){
      category = (category || 'all').toLowerCase();
      q = (q || '').toLowerCase();
      const keys = unitKeys.filter(k => {
        const u = unitDatabase[k];
        if(!u) return false;
        if(!(u.name||'').toLowerCase().includes(q)) return false;
        if(category === 'all') return true;
        return (u.rarity || '').toLowerCase() === category;
      });

      const grid = pickerOverlay.querySelector('#picker-grid');
      if(!keys.length) { grid.innerHTML = `<div class="picker-placeholder">No units match</div>`; return; }

      grid.innerHTML = keys.map(k => {
        const u = unitDatabase[k];
        const portrait = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
        const rslug = (u.rarity||'').toLowerCase();
        return `<div class="picker-thumb rarity-${rslug}" data-key="${k}" title="${escapeHtml(u.name)}">
          <div style="width:100%;height:100%;background-image:${portrait};background-size:cover;background-position:center;"></div>
        </div>`;
      }).join('');

      grid.querySelectorAll('.picker-thumb').forEach(t => {
        t.addEventListener('click', () => {
          const key = t.getAttribute('data-key');
          addToSide(currentPickerSide, key, currentPickerTrait, currentPickerQty);
          pickerOverlay.style.display = 'none';
        });
      });
    }

    plusLeft.addEventListener('click', ()=> openPicker('left', traitLeft.value, Number(qtyLeft.value || 1)));
    plusRight.addEventListener('click', ()=> openPicker('right', traitRight.value, Number(qtyRight.value || 1)));

    addLeft.addEventListener('click', ()=> addToSide('left', leftSelect.value, traitLeft.value, Number(qtyLeft.value || 1)));
    addRight.addEventListener('click', ()=> addToSide('right', rightSelect.value, traitRight.value, Number(qtyRight.value || 1)));
    leftSelect.addEventListener('dblclick', ()=> addToSide('left', leftSelect.value, traitLeft.value, Number(qtyLeft.value || 1)));
    rightSelect.addEventListener('dblclick', ()=> addToSide('right', rightSelect.value, traitRight.value, Number(qtyRight.value || 1)));

    // init
    populateSelects();
    renderList();
    renderThumbs();
    updateTotalsAndVerdict();

    // expose debug arrays
    window._leftItems = leftItems;
    window._rightItems = rightItems;
  })();
  </script>
</body>
</html>
