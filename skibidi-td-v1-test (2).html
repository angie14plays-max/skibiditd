<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <title>Skibidi TD Value List (fixed) + Calculator (picker)</title>
  <style>
    :root {
      --bg-page: #000000;
      --card-bg: #111111;
      --box-bg: #1a1a1a;
      --border-solid: #333333;
      --text-main: #ffffff;
      --text-dim: #777777;
      --gold: #facc15;
      --purple: #a855f7;

      --rising: #22c55e;
      --stable: #f97316;
      --dropping: #ec4899;
      --overpaid: #facc15;
      --underpaid: #ef4444;
      --hyped: #3b82f6;
      --recovering: #555555;
      --unstable: #9d174d;

      --grad-astral: linear-gradient(135deg,#7b00e6,#b800e6,#6cedf0);
      --grad-cosmic: linear-gradient(135deg,#6cedf0,#7b00e6);
      --grad-divine: linear-gradient(135deg,#c400cf,#2248ff);
      --grad-godly: linear-gradient(135deg,#7b00e6,#6367ff);
      --grad-exclusive: linear-gradient(135deg,#2e7dff,#2be7f6);
      --grad-mythic: linear-gradient(135deg,#ff6d68,#cc1d1b);
      --grad-legendary: linear-gradient(135deg,#f5a623,#d48c00);
      --grad-default: linear-gradient(135deg,#444,#222);
    }

    * { font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px; box-sizing: border-box; }

    body {
      background-color: var(--bg-page);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .controls-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #search-bar {
      width: 100%;
      padding: 12px 14px;
      background: var(--card-bg);
      border: 2px solid var(--border-solid);
      border-radius: 12px;
      color: white;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s;
    }
    #search-bar:focus { border-color: var(--gold); }

    .tabs-wrapper, .sort-wrapper {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tab-btn, .sort-btn {
      background: var(--card-bg);
      border: 2px solid var(--border-solid);
      color: var(--text-dim);
      padding: 10px 16px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 12px;
      transition: 0.2s;
      border-radius: 8px;
    }
    .tab-btn:hover, .tab-btn.active, .sort-btn:hover, .sort-btn.active {
      color: white; border-color: var(--gold);
    }

    .list-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      max-width: 1200px;
      width: 100%;
      margin-bottom: 26px;
    }

    .unit-card {
      background-color: var(--card-bg);
      border: 2px solid var(--border-solid);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* Calculator UI */
    .calculator-root {
      width: 100%;
      max-width: 1200px;
      display: none; /* shown when Calculator tab clicked */
      margin-bottom: 28px;
      gap: 16px;
    }
    .calc-inner {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      width: 100%;
    }
    .trade-panel {
      flex: 1;
      background: var(--card-bg);
      border: 2px solid var(--border-solid);
      border-radius: 12px;
      padding: 14px;
      min-height: 320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .trade-title {
      text-align:center;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .trade-title.you { color:#ff4d4d; }
    .trade-title.them { color:#6ea0ff; }

    .add-row {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .add-row select, .add-row input[type="number"]{
      background: var(--box-bg);
      color:var(--text-main);
      border:1px solid var(--border-solid);
      padding:8px;
      border-radius:8px;
      font-size:14px;
    }
    .add-row .btn {
      background: linear-gradient(90deg,var(--purple),var(--gold));
      color:black;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
    }

    /* items area shows thumbnails in a grid (matches your screenshot) */
    .items-list {
      background: rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.04);
      padding:12px;
      border-radius:8px;
      min-height:180px;
      overflow:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-content:flex-start;
    }

    .selected-thumb {
      width:74px; height:74px; border-radius:10px; position:relative;
      display:flex; align-items:center; justify-content:center;
      background:var(--box-bg); border:3px solid rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .thumb-img { width:100%; height:100%; background-size:cover; background-position:center; filter:brightness(.98); }
    .thumb-badge {
      position:absolute; right:4px; bottom:4px;
      background:linear-gradient(90deg,#ff6dcd,#ff8a4d); color:#000; font-weight:800;
      padding:4px 6px; border-radius:8px; font-size:12px;
      box-shadow:0 2px 4px rgba(0,0,0,.6);
    }
    .thumb-remove {
      position:absolute; left:6px; top:6px; background:rgba(0,0,0,0.5); color:#fff; border-radius:6px;
      width:20px; height:20px; display:grid; place-items:center; cursor:pointer; font-weight:900; font-size:12px;
    }

    .total-row { display:flex; justify-content:space-between; align-items:center; margin-top:6px; }
    .total-label { font-weight:900; color:var(--text-dim); }
    .total-value { font-weight:900; background:linear-gradient(90deg,var(--purple),var(--gold)); padding:6px 10px; border-radius:8px; color:#000; }

    .verdict {
      width:260px;
      background:var(--card-bg);
      border:2px solid var(--border-solid);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .status-text { font-weight:900; font-size:18px; }
    .status-fair { color:var(--gold); }
    .status-lose { color:var(--underpaid); }
    .status-over { color:#ff2d6f; }
    .status-win { color:var(--rising); }
    .status-under { color:#12b76a; }

    .balance-bar { width:100%; height:14px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.02); }
    .balance-fill { height:100%; width:50%; background:linear-gradient(90deg,#22c55e,#6ea0ff); }

    /* Unit picker modal (full-screen) */
    .unit-picker-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:9999;
      padding:24px;
    }
    .unit-picker {
      width:100%; max-width:1200px; background:var(--card-bg); border-radius:12px; border:2px solid var(--border-solid);
      padding:16px; display:flex; gap:14px; min-height:420px;
    }
    .picker-sidebar { width:160px; display:flex; flex-direction:column; gap:10px; }
    .picker-cat { padding:10px 12px; border-radius:8px; border:2px solid var(--border-solid); background:transparent; color:var(--text-dim); font-weight:900; cursor:pointer; text-transform:uppercase; }
    .picker-cat.active { color:#fff; border-color:var(--gold); }
    .picker-main { flex:1; display:flex; flex-direction:column; gap:12px; }
    .picker-search { display:flex; gap:8px; }
    .picker-search input { flex:1; padding:10px; border-radius:8px; background:var(--box-bg); border:1px solid var(--border-solid); color:var(--text-main); }
    .picker-grid { background:rgba(0,0,0,0.02); border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.03);
      display:grid; grid-template-columns: repeat(auto-fill, 54px); gap:10px; align-content:start; overflow:auto; padding-bottom:8px;
    }

    /* rarity border helpers */
    .rarity-astral .selected-thumb { border-image: none; box-shadow: 0 0 0 3px rgba(123,0,230,0.06) inset; }
    .rarity-astral .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-astral); opacity:0.95; z-index:-1; }

    .rarity-cosmic .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-cosmic); z-index:-1; }
    .rarity-divine .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-divine); z-index:-1; }
    .rarity-godly .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-godly); z-index:-1; }
    .rarity-exclusive .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-exclusive); z-index:-1; }
    .rarity-mythic .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-mythic); z-index:-1; }
    .rarity-legendary .selected-thumb::after { content:''; position:absolute; inset:-3px; border-radius:10px; background:var(--grad-legendary); z-index:-1; }

    @media (max-width:1024px) { .list-container { grid-template-columns: repeat(2,1fr); } .calc-inner { flex-direction:column; } .verdict { width:100%; } .unit-picker { flex-direction:column; min-height:520px; } .picker-sidebar{width:100%; display:flex; overflow:auto;} .picker-grid{grid-template-columns: repeat(auto-fill, 64px);} }
    @media (max-width:600px) { .list-container { grid-template-columns: 1fr; } .portrait-frame { width:90px; height:90px; } .unit-image { width:100px; height:100px; } .picker-grid{grid-template-columns: repeat(auto-fill, 64px);} }
  </style>
</head>
<body>
  <div class="controls-container">
    <input type="text" id="search-bar" placeholder="Search unit...">

    <div class="tabs-wrapper" id="tabs-container">
      <button class="tab-btn active" data-rarity="all">All</button>
      <button class="tab-btn" data-rarity="astral">Astral</button>
      <button class="tab-btn" data-rarity="cosmic">Cosmic</button>
      <button class="tab-btn" data-rarity="divine">Divine</button>
      <button class="tab-btn" data-rarity="godly">Godly</button>
      <button class="tab-btn" data-rarity="exclusive">Exclusive</button>
      <button class="tab-btn" data-rarity="mythic">Mythic</button>
      <button class="tab-btn" data-rarity="legendary">Legendary</button>
      <!-- Calculator tab -->
      <button class="tab-btn" data-rarity="calculator" id="calculator-tab">Calculator</button>
    </div>

    <div class="sort-wrapper" id="sort-container">
      <button class="sort-btn active" data-sort="default">Default Sort</button>
      <button class="sort-btn" data-sort="value-desc">High Value</button>
    </div>
  </div>

  <div id="list-root" class="list-container"></div>

  <!-- Calculator panel -->
  <div id="calculator-root" class="calculator-root">
    <div class="calc-inner">
      <div class="trade-panel" id="left-panel">
        <div class="trade-title you">Your Value</div>

        <div class="add-row">
          <select id="unit-select-left"></select>
          <select id="trait-select-left">
            <option value="base">Base</option>
            <option value="grandmaster">Grandmaster</option>
            <option value="master">Master</option>
            <option value="superPayday">Super Payday</option>
            <option value="sniper">Sniper</option>
          </select>
          <input id="qty-left" type="number" min="1" value="1" />
          <!-- Opens unit picker modal -->
          <button class="btn" data-side="left" id="add-left">Add</button>
        </div>

        <div class="items-list" id="left-items"></div>

        <div class="total-row">
          <div class="total-label">Total</div>
          <div class="total-value" id="left-total">0</div>
        </div>
      </div>

      <div class="trade-panel" id="right-panel">
        <div class="trade-title them">Their Value</div>

        <div class="add-row">
          <select id="unit-select-right"></select>
          <select id="trait-select-right">
            <option value="base">Base</option>
            <option value="grandmaster">Grandmaster</option>
            <option value="master">Master</option>
            <option value="superPayday">Super Payday</option>
            <option value="sniper">Sniper</option>
          </select>
          <input id="qty-right" type="number" min="1" value="1" />
          <!-- Opens unit picker modal -->
          <button class="btn" data-side="right" id="add-right">Add</button>
        </div>

        <div class="items-list" id="right-items"></div>

        <div class="total-row">
          <div class="total-label">Total</div>
          <div class="total-value" id="right-total">0</div>
        </div>
      </div>

      <div class="verdict" id="verdict-panel">
        <div class="status-text" id="verdict-text">No items</div>
        <div class="balance-bar">
          <div class="balance-fill" id="balance-fill" style="width:50%"></div>
        </div>
        <div class="small muted" id="verdict-details" style="color:var(--text-dim); font-size:13px; text-align:center;">Add units on each side to compare values.</div>
        <div style="width:100%; display:flex; gap:8px; margin-top:6px;">
          <button class="btn" id="clear-left" style="flex:1; background:#ef4444; color:#fff;">Clear Yours</button>
          <button class="btn" id="clear-right" style="flex:1; background:#6ea0ff; color:#000;">Clear Theirs</button>
        </div>
      </div>
    </div>
  </div>

  <div class="pagination-container">
    <button class="pagination-btn" id="prev-btn">Previous</button>
    <span class="page-info" id="page-info">Page 1 of 1</span>
    <button class="pagination-btn" id="next-btn">Next</button>
  </div>

  <!-- Unit data -->
  <script src="skibidi-td-data.js"></script>

  <!-- Render list script (same as before) -->
  <script>
  (function () {
    function showFatal(message) {
      console.error(message);
      let overlay = document.getElementById('debug-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'debug-overlay';
        Object.assign(overlay.style, {
          position: 'fixed', left: 0, right: 0, top: 0, padding: '12px',
          background: '#b91c1c', color: 'white', zIndex: 99999, fontFamily: 'sans-serif',
          fontSize: '14px', textAlign: 'center'
        });
        document.body.appendChild(overlay);
      }
      overlay.textContent = message;
    }

    function parseValue(valString) {
      if (valString === 0) return 0;
      if (!valString && valString !== 0) return 0;
      let s = String(valString).trim();
      s = s.replace(/[\$\€\£\¥\₹]/g, '').replace(/\s+/g, '');
      const fullMatch = s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/);
      if (fullMatch) {
        let numPart = fullMatch[1].replace(/,/g, '');
        let num = parseFloat(numPart) || 0;
        const suffix = fullMatch[2];
        if (suffix) {
          const sfx = suffix.toLowerCase();
          if (sfx === 'k') num *= 1e3;
          else if (sfx === 'm') num *= 1e6;
        }
        return num;
      }
      const numericMatch = s.match(/[\d.]+/);
      return numericMatch ? parseFloat(numericMatch[0].replace(/,/g, '')) : 0;
    }
    window.parseValue = parseValue;

    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof unitDatabase === 'undefined') {
          showFatal('Error: unitDatabase is not defined. Make sure skibidi-td-data.js is loaded and defines a global "unitDatabase". Check DevTools Console for script load errors.');
          return;
        }
        if (!document.getElementById('list-root')) {
          showFatal('Error: DOM element #list-root not found. Ensure this script runs after the HTML markup.');
          return;
        }

        const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";
        let currentFilter = 'all';
        let searchQuery = '';
        let currentSort = 'default';
        let currentPage = 1;
        const itemsPerPage = 15;

        const rarityOrder = {
          'astral': 1,
          'cosmic': 2,
          'godly': 3,
          'divine': 4,
          'mythic': 5,
          'legendary': 6,
          'exclusive': 99
        };

        const traitsMeta = {
          grandmaster: { id: "1C1TJwQXNqvM0r9g32fq5_j3r6g-B01DF", label: "Grandmaster" },
          master: { id: "1oaTPE4cr2UyiHDX_nDo41efOyUboWoMV", label: "Master" },
          superPayday: { id: "1T1DtpHB_cf4xx1ynNjjzOWXzCeC_bAbk", label: "Super Payday" },
          sniper: { id: "1Y4AdKn1XXEKxVMRgzZYANJLbjRuuHobJ", label: "Sniper" }
        };

        const formatStatusClass = (status) => (status || '').toLowerCase().replace(/\s+/g, '-');

        function updateUnitStats(unitKey, traitKey) {
          const unit = unitDatabase[unitKey];
          const card = document.querySelector(`[data-unit="${unitKey}"]`);
          if (!unit || !card) return;
          const stats = traitKey ? unit.traits[traitKey] : unit.baseStats;
          const valueEl = card.querySelector('.val-value');
          const demandEl = card.querySelector('.val-demand');
          const statusEl = card.querySelector('.val-status');

          if (valueEl) valueEl.innerText = stats.value;
          if (demandEl) demandEl.innerText = stats.demand;
          if (statusEl) {
            statusEl.innerText = stats.status;
            statusEl.className = `val val-status status-${formatStatusClass(stats.status)}`;
          }

          card.querySelectorAll('.icon-slot').forEach(slot => {
            slot.classList.remove('active');
            if (slot.getAttribute('data-trait') === traitKey) slot.classList.add('active');
          });
        }
        window.updateUnitStats = updateUnitStats;

        function buildTraitIcon(traitKey, unitKey) {
          const meta = traitsMeta[traitKey];
          if (!meta) return '';
          const imgPath = `url('${imageProvider}${meta.id}')`;
          return `
            <div class="icon-slot" data-trait="${traitKey}" title="${meta.label}" onclick="updateUnitStats('${unitKey}', '${traitKey}')">
              <div class="icon-img" style="--asset-path: ${imgPath}"></div>
              <div class="effect-overlay" style="--asset-path: ${imgPath}"></div>
            </div>`;
        }

        function renderValueList() {
          try {
            const root = document.getElementById('list-root');
            if (!root) throw new Error('#list-root missing');
            let filteredKeys = Object.keys(unitDatabase).filter(key => {
              const unit = unitDatabase[key];
              const uRarity = (unit.rarity || '').toLowerCase();
              const matchesRarity = currentFilter === 'all' || uRarity === currentFilter;
              const matchesSearch = (unit.name || '').toLowerCase().includes(searchQuery.toLowerCase());
              return matchesRarity && matchesSearch;
            });

            filteredKeys.sort((a, b) => {
              const unitA = unitDatabase[a];
              const unitB = unitDatabase[b];

              if (currentSort === 'value-desc') {
                return parseValue(unitB.baseStats.value) - parseValue(unitA.baseStats.value);
              } else {
                const weightA = rarityOrder[(unitA.rarity || '').toLowerCase()] || 999;
                const weightB = rarityOrder[(unitB.rarity || '').toLowerCase()] || 999;
                if (weightA !== weightB) return weightA - weightB;
                return (unitA.name || '').localeCompare(unitB.name || '');
              }
            });

            const totalPages = Math.max(1, Math.ceil(filteredKeys.length / itemsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedKeys = filteredKeys.slice(startIndex, startIndex + itemsPerPage);

            const pageInfoEl = document.getElementById('page-info');
            if (pageInfoEl) pageInfoEl.innerText = `Page ${currentPage} of ${totalPages}`;
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;

            root.innerHTML = paginatedKeys.map(key => {
              const unit = unitDatabase[key];
              const portraitUrl = `url('${imageProvider}${unit.unitId}')`;
              const statusClass = formatStatusClass(unit.baseStats.status);
              const isSecondEdition = unit.secondEdition && unit.secondEdition.toLowerCase() === "yes";
              const editionSub = isSecondEdition ? `<div class="second-edition-tag">2nd Edition</div>` : '';
              const raritySlug = (unit.rarity || '').toLowerCase();

              return `
                <div class="unit-card rarity-${raritySlug}" data-unit="${key}">
                  <div class="header-section">
                    <div class="unit-title">${unit.name}</div>
                    ${editionSub}
                  </div>
                  <div class="card-body">
                    <div class="buff-column">
                      ${buildTraitIcon('grandmaster', key)}
                      ${buildTraitIcon('master', key)}
                    </div>
                    <div class="portrait-frame" onclick="updateUnitStats('${key}', null)" title="Reset to Base Stats">
                      <div class="unit-image" style="--unit-img: ${portraitUrl}"></div>
                    </div>
                    <div class="buff-column">
                      ${buildTraitIcon('superPayday', key)}
                      ${buildTraitIcon('sniper', key)}
                    </div>
                  </div>
                  <div class="data-table">
                    <div class="data-cell">
                      <span class="label">Value</span>
                      <span class="val val-value highlight-gold">${unit.baseStats.value}</span>
                    </div>
                    <div class="data-cell">
                      <span class="label">Status</span>
                      <span class="val val-status status-${statusClass}">${unit.baseStats.status}</span>
                    </div>
                    <div class="data-cell">
                      <span class="label">Demand</span>
                      <span class="val val-demand highlight-purple">${unit.baseStats.demand}</span>
                    </div>
                  </div>
                </div>`; 
            }).join('');
          } catch (err) {
            console.error('renderValueList error:', err);
            showFatal('A runtime error occurred while rendering the list. Check the console for details.');
          }
        }

        const searchBar = document.getElementById('search-bar');
        if (searchBar) {
          searchBar.addEventListener('input', (e) => {
            searchQuery = e.target.value || '';
            currentPage = 1;
            renderValueList();
          });
        }

        const tabsContainer = document.getElementById('tabs-container');
        if (tabsContainer) {
          tabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
              e.target.classList.add('active');
              currentFilter = e.target.getAttribute('data-rarity') || 'all';

              // Show/hide calculator
              const calcRoot = document.getElementById('calculator-root');
              const listRoot = document.getElementById('list-root');
              if (currentFilter === 'calculator') {
                if (calcRoot) calcRoot.style.display = 'block';
                if (listRoot) listRoot.style.display = 'none';
              } else {
                if (calcRoot) calcRoot.style.display = 'none';
                if (listRoot) listRoot.style.display = '';
                currentPage = 1;
                renderValueList();
              }
            }
          });
        }

        const sortContainer = document.getElementById('sort-container');
        if (sortContainer) {
          sortContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('sort-btn')) {
              document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
              e.target.classList.add('active');
              currentSort = e.target.getAttribute('data-sort') || 'default';
              currentPage = 1;
              renderValueList();
            }
          });
        }

        const prevBtn = document.getElementById('prev-btn');
        if (prevBtn) prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderValueList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) nextBtn.addEventListener('click', () => {
          const filteredTotal = Object.keys(unitDatabase).filter(key => {
            const u = unitDatabase[key];
            return (currentFilter === 'all' || (u.rarity || '').toLowerCase() === currentFilter) &&
                   (u.name || '').toLowerCase().includes(searchQuery.toLowerCase());
          }).length;
          const maxPage = Math.ceil(filteredTotal / itemsPerPage) || 1;
          if (currentPage < maxPage) {
            currentPage++;
            renderValueList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });

        // initial render
        renderValueList();

      } catch (err) {
        console.error('Initialization error:', err);
        showFatal('A fatal error occurred during initialization. See console.');
      }
    });
  })();
  </script>

  <!-- Calculator + Unit Picker script -->
  <script>
    (function () {
      // thresholds
      const FAIR_THRESHOLD = 0.02;   // 2%
      const SMALL_DIFF = 0.10;      // 10%

      function abbr(n) {
        if (!isFinite(n) || n === 0) return '0';
        if (n >= 1e6) return +(n / 1e6).toFixed(2) + 'M';
        if (n >= 1e3) return +(n / 1e3).toFixed(2) + 'K';
        return Math.round(n).toLocaleString();
      }
      function comma(n) {
        if (!isFinite(n)) return '0';
        return Math.round(n).toLocaleString();
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (typeof unitDatabase === 'undefined') return;

        // Elements
        const unitSelectLeft = document.getElementById('unit-select-left');
        const unitSelectRight = document.getElementById('unit-select-right');
        const traitLeft = document.getElementById('trait-select-left');
        const traitRight = document.getElementById('trait-select-right');
        const qtyLeft = document.getElementById('qty-left');
        const qtyRight = document.getElementById('qty-right');
        const addLeftBtn = document.getElementById('add-left');
        const addRightBtn = document.getElementById('add-right');
        const leftItemsEl = document.getElementById('left-items');
        const rightItemsEl = document.getElementById('right-items');
        const leftTotalEl = document.getElementById('left-total');
        const rightTotalEl = document.getElementById('right-total');
        const verdictText = document.getElementById('verdict-text');
        const verdictDetails = document.getElementById('verdict-details');
        const balanceFill = document.getElementById('balance-fill');
        const clearLeft = document.getElementById('clear-left');
        const clearRight = document.getElementById('clear-right');

        // unit picker elements will be created below
        let pickerOverlay, pickerGrid, pickerSearch, pickerSidebar;

        // Data stores
        const unitKeys = Object.keys(unitDatabase).sort((a,b) => (unitDatabase[a].name || '').localeCompare(unitDatabase[b].name || ''));
        const leftItems = [];
        const rightItems = [];

        // populate selects for convenience (keeps original dropdowns workable)
        function populateUnitSelects() {
          const makeOption = (key) => {
            const u = unitDatabase[key];
            const display = `${u.name} (${u.rarity || 'unknown'}) — ${u.baseStats.value || 'N/A'}`;
            return `<option value="${key}">${escapeHtml(display)}</option>`;
          };
          unitSelectLeft.innerHTML = unitKeys.map(makeOption).join('');
          unitSelectRight.innerHTML = unitKeys.map(makeOption).join('');
        }
        function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";

        function readUnitValue(key, trait) {
          const unit = unitDatabase[key];
          if (!unit) return 0;
          if (trait && trait !== 'base' && unit.traits && unit.traits[trait]) {
            return parseValue(unit.traits[trait].value);
          }
          return parseValue(unit.baseStats.value);
        }

        function addItem(side, key, trait, qty) {
          qty = Math.max(1, Math.floor(qty) || 1);
          const numericSingle = readUnitValue(key, trait);
          const computedValue = numericSingle * qty;
          const item = {
            id: `${key}:${trait}:${Date.now()}${Math.random().toString(36).slice(2,6)}`,
            key, trait, qty, numericSingle, computedValue
          };
          if (side === 'left') leftItems.push(item); else rightItems.push(item);
          renderLists();
          computeAndUpdate();
        }

        function removeItem(side, id) {
          if (side === 'left') {
            const idx = leftItems.findIndex(i=>i.id===id);
            if (idx>=0) leftItems.splice(idx,1);
          } else {
            const idx = rightItems.findIndex(i=>i.id===id);
            if (idx>=0) rightItems.splice(idx,1);
          }
          renderLists();
          computeAndUpdate();
        }

        // Renders thumbnail grid for selected items (matches screenshot)
        function renderLists() {
          function thumbHTML(it) {
            const unit = unitDatabase[it.key] || {};
            const portrait = unit.unitId ? `url('${imageProvider}${unit.unitId}')` : '';
            const raritySlug = (unit.rarity || '').toLowerCase();
            return `
              <div class="selected-thumb rarity-${raritySlug}" data-id="${it.id}" data-side="">
                <div class="thumb-remove" data-id="${it.id}" title="Remove">×</div>
                <div class="thumb-img" style="background-image: ${portrait};"></div>
                <div class="thumb-badge">${escapeHtml(String(it.qty))}</div>
              </div>`;
          }
          leftItemsEl.innerHTML = leftItems.map(it => {
            const unit = unitDatabase[it.key] || {};
            const portrait = unit.unitId ? `url('${imageProvider}${unit.unitId}')` : '';
            const raritySlug = (unit.rarity || '').toLowerCase();
            return `
              <div class="selected-thumb rarity-${raritySlug}" data-id="${it.id}" data-side="left">
                <div class="thumb-remove" data-id="${it.id}" data-side="left">×</div>
                <div class="thumb-img" style="background-image: ${portrait};"></div>
                <div class="thumb-badge">${escapeHtml(String(it.qty))}</div>
              </div>`;
          }).join('');
          rightItemsEl.innerHTML = rightItems.map(it => {
            const unit = unitDatabase[it.key] || {};
            const portrait = unit.unitId ? `url('${imageProvider}${unit.unitId}')` : '';
            const raritySlug = (unit.rarity || '').toLowerCase();
            return `
              <div class="selected-thumb rarity-${raritySlug}" data-id="${it.id}" data-side="right">
                <div class="thumb-remove" data-id="${it.id}" data-side="right">×</div>
                <div class="thumb-img" style="background-image: ${portrait};"></div>
                <div class="thumb-badge">${escapeHtml(String(it.qty))}</div>
              </div>`;
          }).join('');

          // attach remove handlers
          document.querySelectorAll('.thumb-remove').forEach(btn => {
            btn.removeEventListener('click', thumbRemoveHandler);
            btn.addEventListener('click', thumbRemoveHandler);
          });
        }

        function thumbRemoveHandler(e) {
          const id = e.currentTarget.getAttribute('data-id');
          const side = e.currentTarget.getAttribute('data-side');
          removeItem(side, id);
        }

        function sumList(list) {
          return list.reduce((s,it) => s + Number(it.computedValue || 0), 0);
        }

        function computeAndUpdate() {
          leftItems.forEach(it => it.computedValue = (it.numericSingle || 0) * (it.qty || 1));
          rightItems.forEach(it => it.computedValue = (it.numericSingle || 0) * (it.qty || 1));

          const leftSum = sumList(leftItems);
          const rightSum = sumList(rightItems);

          leftTotalEl.innerText = abbr(leftSum);
          rightTotalEl.innerText = abbr(rightSum);

          // balance fill percent
          const total = leftSum + rightSum;
          let leftPct = total === 0 ? 50 : Math.round((leftSum / (total || 1)) * 100);
          leftPct = Math.max(0, Math.min(100, leftPct));
          balanceFill.style.width = leftPct + '%';

          // verdict logic
          let verdict = 'No items';
          let details = 'Add units on each side to compare values.';
          let statusClass = '';

          if (leftSum === 0 && rightSum === 0) {
            verdict = 'No items';
            statusClass = 'status-fair';
          } else {
            if (Math.abs(leftSum - rightSum) <= Math.max(1, FAIR_THRESHOLD * Math.max(leftSum, rightSum))) {
              verdict = 'Fair';
              details = `Totals are within ${(FAIR_THRESHOLD*100).toFixed(0)}% of each other.`;
              statusClass = 'status-fair';
            } else if (leftSum > rightSum) {
              if (rightSum === 0 || leftSum > rightSum * (1 + SMALL_DIFF)) {
                verdict = 'Overpaying';
                details = `You're giving ${formatPercentDifference(leftSum, rightSum)} more than them. Consider lowering your offer.`;
                statusClass = 'status-over';
              } else {
                verdict = 'Lose';
                details = `You're giving slightly more (${formatPercentDifference(leftSum, rightSum)}).`;
                statusClass = 'status-lose';
              }
            } else {
              if (leftSum === 0 || rightSum > leftSum * (1 + SMALL_DIFF)) {
                verdict = 'Underpaying';
                details = `You're receiving ${formatPercentDifference(rightSum, leftSum)} more value — great deal for you.`;
                statusClass = 'status-under';
              } else {
                verdict = 'Win';
                details = `You're getting a better deal (${formatPercentDifference(rightSum, leftSum)}).`;
                statusClass = 'status-win';
              }
            }
          }

          verdictText.innerText = verdict;
          verdictText.className = 'status-text ' + statusClass;
          verdictDetails.innerText = details;
        }

        function formatPercentDifference(a, b) {
          if (!isFinite(a) || !isFinite(b)) return 'N/A';
          if (b === 0) return '∞%';
          const pct = ((a - b) / b) * 100;
          return Math.abs(pct).toFixed(0) + '%';
        }

        // Clear buttons
        clearLeft.addEventListener('click', () => { leftItems.splice(0,leftItems.length); renderLists(); computeAndUpdate(); });
        clearRight.addEventListener('click', () => { rightItems.splice(0,rightItems.length); renderLists(); computeAndUpdate(); });

        // populate selects & initial render
        populateUnitSelects();
        renderLists();
        computeAndUpdate();

        // ------------ Unit Picker Modal -------------
        function createPicker() {
          pickerOverlay = document.createElement('div');
          pickerOverlay.className = 'unit-picker-overlay';
          pickerOverlay.innerHTML = `
            <div class="unit-picker">
              <div class="picker-sidebar" id="picker-sidebar"></div>
              <div class="picker-main">
                <div class="picker-search"><input id="picker-search-input" placeholder="SEARCH UNITS..." /></div>
                <div class="picker-grid" id="picker-grid"></div>
              </div>
            </div>`;
          document.body.appendChild(pickerOverlay);

          pickerGrid = pickerOverlay.querySelector('#picker-grid');
          pickerSearch = pickerOverlay.querySelector('#picker-search-input');
          pickerSidebar = pickerOverlay.querySelector('#picker-sidebar');

          // categories (left buttons) — you can change labels to match your categories
          const categories = ['ALL','APEX','EVOLUTIONS','FORGOTTEN','NIGHTMARES','SECRETS','MYTHICS+','ITEMS','DEVELOPER','LOOKING FOR'];
          pickerSidebar.innerHTML = categories.map(cat => `<div class="picker-cat" data-cat="${cat.toLowerCase()}">${cat}</div>`).join('');

          // attach category handlers
          pickerSidebar.querySelectorAll('.picker-cat').forEach(btn => {
            btn.addEventListener('click', (e) => {
              pickerSidebar.querySelectorAll('.picker-cat').forEach(x=>x.classList.remove('active'));
              btn.classList.add('active');
              // For now categories only act as visual grouping; we still filter by rarity/search
              const cat = btn.getAttribute('data-cat');
              renderPickerGrid(currentPickerSide, currentPickerTrait, currentPickerQty, pickerSearch.value || '', cat);
            });
          });
          // mark ALL active by default
          const first = pickerSidebar.querySelector('.picker-cat');
          if (first) first.classList.add('active');

          pickerSearch.addEventListener('input', () => {
            renderPickerGrid(currentPickerSide, currentPickerTrait, currentPickerQty, pickerSearch.value || '');
          });

          // close on overlay click outside panel
          pickerOverlay.addEventListener('click', (ev) => {
            if (ev.target === pickerOverlay) closePicker();
          });
        }

        // build grid of icons; filters: search, rarityCategory
        function renderPickerGrid(side, trait, qty, q, category) {
          q = (q || '').toLowerCase();
          const keys = unitKeys.filter(k => {
            const u = unitDatabase[k];
            if (!u) return false;
            // optional: map categories to rarities; by default 'all' shows everything
            if (category && category !== 'all' && category !== 'apex') {
              // using category only as UI grouping; don't exclude units unless you want mapping
            }
            return (u.name || '').toLowerCase().includes(q);
          });

          pickerGrid.innerHTML = keys.map(k => {
            const u = unitDatabase[k];
            const portrait = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
            const raritySlug = (u.rarity || '').toLowerCase();
            const display = `${u.name} (${u.rarity || ''})`;
            return `
              <div class="picker-thumb rarity-${raritySlug}" data-key="${k}" title="${escapeHtml(display)}" style="width:48px; height:48px; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid rgba(255,255,255,0.04); background:var(--box-bg);">
                <div style="width:100%; height:100%; background-image:${portrait}; background-size:cover; background-position:center;"></div>
              </div>`;
          }).join('');
          // attach click handlers for thumbs
          pickerGrid.querySelectorAll('.picker-thumb').forEach(t => {
            t.addEventListener('click', (e) => {
              const key = t.getAttribute('data-key');
              // Add item to chosen side
              addItem(currentPickerSide, key, currentPickerTrait, currentPickerQty);
              closePicker();
            });
          });
        }

        function openPicker(side, trait, qty) {
          currentPickerSide = side;
          currentPickerTrait = trait;
          currentPickerQty = Math.max(1, Math.floor(qty) || 1);
          if (!pickerOverlay) createPicker();
          pickerOverlay.style.display = 'flex';
          // prefill search
          const c = pickerOverlay.querySelector('.picker-cat.active');
          const cat = c ? c.getAttribute('data-cat') : 'all';
          renderPickerGrid(side, trait, qty, '', cat);
          setTimeout(()=> pickerOverlay.querySelector('#picker-search-input').focus(), 120);
        }
        function closePicker() {
          if (pickerOverlay) pickerOverlay.style.display = 'none';
        }

        // store current picker state
        let currentPickerSide = 'left';
        let currentPickerTrait = 'base';
        let currentPickerQty = 1;

        // change Add buttons to open the picker modal
        addLeftBtn.addEventListener('click', () => {
          currentPickerSide = 'left';
          currentPickerTrait = traitLeft.value;
          currentPickerQty = Number(qtyLeft.value || 1);
          openPicker('left', currentPickerTrait, currentPickerQty);
        });
        addRightBtn.addEventListener('click', () => {
          currentPickerSide = 'right';
          currentPickerTrait = traitRight.value;
          currentPickerQty = Number(qtyRight.value || 1);
          openPicker('right', currentPickerTrait, currentPickerQty);
        });

        // also make double-click on a select's chosen unit quick-add (optional convenience)
        unitSelectLeft.addEventListener('dblclick', () => {
          const key = unitSelectLeft.value;
          addItem('left', key, traitLeft.value, Number(qtyLeft.value || 1));
        });
        unitSelectRight.addEventListener('dblclick', () => {
          const key = unitSelectRight.value;
          addItem('right', key, traitRight.value, Number(qtyRight.value || 1));
        });

        // allow closing picker with Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && pickerOverlay && pickerOverlay.style.display === 'flex') closePicker();
        });

        // focus helper when switching to calculator tab
        const calcTab = document.getElementById('calculator-tab');
        if (calcTab) calcTab.addEventListener('click', () => setTimeout(()=> unitSelectLeft.focus(), 150));
      });
    })();
  </script>
</body>
</html>
