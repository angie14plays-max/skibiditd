<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skibidi TD — 3-dot Menu, Centered UI, Polished Badges</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#060606;
      --card:#0f0f11;
      --panel:#121316;
      --muted:#9aa0a5;
      --text:#ffffff;
      --border:#222428;
      --radius:12px;

      --g-astral: linear-gradient(90deg,#7f00ff,#00ffd5);
      --g-cosmic: linear-gradient(90deg,#b800e6,#6cedf0);
      --g-divine: linear-gradient(90deg,#ff00c8,#2248ff);
      --g-godly: linear-gradient(90deg,#7b00e6,#6367ff);
      --g-exclusive: linear-gradient(90deg,#00d1ff,#4fe0a3);
      --g-mythic: linear-gradient(90deg,#ff6d68,#ffb86b);
      --g-legendary: linear-gradient(90deg,#ffd54a,#ff7a00);
      --accent: linear-gradient(90deg,#8b4bff,#ff2d6f);
    }

    *{box-sizing:border-box;font-family:'Montserrat',sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    body{padding:22px;display:flex;flex-direction:column;align-items:center;gap:18px}

    /* -- Top area -- */
    .top-wrap { width:100%; max-width:1200px; display:flex; flex-direction:column; gap:12px; align-items:center; margin:0 auto; }
    .search-row { width:100%; display:flex; align-items:center; gap:12px; }
    #search-bar { flex:1; padding:12px 16px; border-radius:20px; background:var(--card); border:1px solid var(--border); color:var(--text); outline:none; font-size:15px; }
    /* 3-dot (Chrome style) menu button */
    .menu-btn { width:44px; height:44px; border-radius:50%; background:var(--card); border:1px solid var(--border); display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    .menu-btn .dots { width:6px; height:6px; background:var(--muted); border-radius:50%; box-shadow: 0 -10px 0 0 var(--muted), 0 10px 0 0 var(--muted); }

    /* menu panel (Chrome-like) */
    .menu-panel { position:absolute; top:76px; right:22px; min-width:260px; background:#fff; color:#000; border-radius:10px; box-shadow:0 14px 48px rgba(0,0,0,0.6); border:1px solid rgba(0,0,0,0.08); overflow:hidden; display:none; z-index:9999; }
    .menu-section { padding:8px; display:flex; flex-direction:column; gap:6px; }
    .menu-item { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:8px; cursor:pointer; transition:background .08s; user-select:none; }
    .menu-item:hover { background:rgba(0,0,0,0.04); }
    .menu-icon { width:28px; height:28px; background-size:22px 22px; background-repeat:no-repeat; background-position:center; opacity:0.95; }
    .menu-label { font-weight:900; text-transform:uppercase; font-size:13px; color:#111; }

    /* center the list area */
    .list-root { width:100%; max-width:1200px; display:grid; grid-template-columns:repeat(3,1fr); gap:24px; margin-top:6px; margin-bottom:18px; }

    /* unit card */
    .unit-card { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border-radius:var(--radius); padding:18px; border:1px solid var(--border); min-height:320px; display:flex; flex-direction:column; justify-content:space-between; }
    .unit-title { font-weight:900; text-transform:uppercase; text-align:center; letter-spacing:0.6px; font-size:16px; }
    .portrait { width:120px; height:120px; border-radius:50%; margin:12px auto; background:#0b0b0b; border:3px solid rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; }
    .portrait .img { width:110px; height:110px; border-radius:50%; background-size:cover; background-position:center; }

    /* apply persistent rarity tint & portrait halo */
    .unit-card.rarity-astral::after { content:''; position:absolute; inset:0; background:var(--g-astral); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-cosmic::after { content:''; position:absolute; inset:0; background:var(--g-cosmic); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-divine::after { content:''; position:absolute; inset:0; background:var(--g-divine); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-godly::after { content:''; position:absolute; inset:0; background:var(--g-godly); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-exclusive::after { content:''; position:absolute; inset:0; background:var(--g-exclusive); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-mythic::after { content:''; position:absolute; inset:0; background:var(--g-mythic); opacity:0.06; border-radius:var(--radius); pointer-events:none; }
    .unit-card.rarity-legendary::after { content:''; position:absolute; inset:0; background:var(--g-legendary); opacity:0.06; border-radius:var(--radius); pointer-events:none; }

    .unit-card.rarity-astral .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-astral); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-cosmic .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-cosmic); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-divine .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-divine); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-godly .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-godly); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-exclusive .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-exclusive); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-mythic .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-mythic); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }
    .unit-card.rarity-legendary .portrait::before { content:''; position:absolute; width:140px; height:140px; border-radius:50%; background:var(--g-legendary); z-index:-1; opacity:0.95; transform:translateY(-6px); filter:blur(18px); }

    /* Info boxes (value / status / demand) - centered and consistent */
    .info-row { display:flex; gap:12px; justify-content:center; align-items:center; margin-top:8px; }
    .info-box { min-width:110px; background:var(--panel); border-radius:10px; padding:12px 14px; text-align:center; border:1px solid var(--border); }
    .info-box .label { display:block; color:var(--muted); font-weight:800; font-size:11px; text-transform:uppercase; }
    .info-box .value { display:block; font-weight:900; margin-top:6px; }

    /* status color mapping (use user-provided colors) */
    .status-badge { padding:6px 10px; border-radius:8px; font-weight:900; text-transform:uppercase; font-size:12px; display:inline-block; }
    .status-stable { background:linear-gradient(90deg,#f97316,#ffb86b); color:#2a1000; }
    .status-high-demand { background:linear-gradient(90deg,#7c3aed,#a78bfa); color:#fff; }
    .status-hyped { background:linear-gradient(90deg,#06b6d4,#7ef0f7); color:#021; }
    .status-dropping { background:linear-gradient(90deg,#ef4444,#ff8a8a); color:#200; }
    .status-unstable { background:linear-gradient(90deg,#9d174d,#ff95c9); color:#23020a; }
    .status-recovering { background:linear-gradient(90deg,#65a30d,#bef264); color:#032; }
    .status-default { background:linear-gradient(90deg,#6b7280,#9ca3af); color:#fff; }

    .demand-pill { padding:6px 8px; border-radius:8px; font-weight:900; display:inline-block; color:#fff; }
    .demand-low { background: linear-gradient(90deg,#6b7280,#9ca3af); }
    .demand-mid { background: linear-gradient(90deg,#f97316,#ffb86b); color:#120; }
    .demand-high { background: linear-gradient(90deg,#16a34a,#6fe89a); color:#012; }

    /* Calculator thumbnails */
    .calc-thumb { width:76px; height:76px; border-radius:10px; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; border:3px solid rgba(255,255,255,0.04); background:var(--panel); }
    .calc-thumb .img { width:100%; height:100%; background-size:cover; background-position:center; border-radius:8px; }
    .soap-badge { position:absolute; right:6px; top:6px; padding:4px 6px; border-radius:8px; background:linear-gradient(90deg,#fff7cc,#fff1a8); color:#3b2f00; font-weight:900; font-size:11px; z-index:4; }

    /* small helpers & responsiveness */
    @media (max-width:1024px){ .list-root{ grid-template-columns:repeat(2,1fr) } .menu-panel{ right:10px } }
    @media (max-width:600px){ .list-root{ grid-template-columns:1fr } .unit-card{ min-height:260px } .portrait{ width:96px; height:96px } .portrait .img{ width:86px; height:86px } }
  </style>
</head>
<body>

  <div class="top-wrap">
    <div class="search-row" style="width:100%;max-width:1200px;position:relative">
      <input id="search-bar" placeholder="Search unit..." aria-label="Search units" />
      <!-- 3-dot menu button -->
      <div class="menu-btn" id="menu-btn" title="Menu" style="margin-left:10px">
        <div class="dots" aria-hidden="true"></div>
      </div>

      <!-- Chrome-like menu panel (hidden by default) -->
      <div class="menu-panel" id="menu-panel" role="menu" aria-hidden="true">
        <div class="menu-section">
          <!-- Calculator first -->
          <div class="menu-item" data-key="calculator"><div class="menu-icon" style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect width=%2224%22 height=%2224%22 rx=%223%22 fill=%22%238b4bff%22/></svg>')"></div><div class="menu-label">Calculator</div></div>
        </div>
        <div class="menu-section" style="border-top:1px solid rgba(0,0,0,0.04) ;">
          <!-- All + rarities (full-color badges inside menu items) -->
          <div class="menu-item" data-key="all"><div class="menu-icon" style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><rect width=%2224%22 height=%2224%22 rx=%224%22 fill=%22%23bdbdbd%22/></svg>')"></div><div class="menu-label">All</div></div>

          <div class="menu-item" data-key="astral"><div class="menu-icon" style="background-image:linear-gradient(90deg,#7f00ff,#00ffd5);"></div><div class="menu-label">Astral</div></div>
          <div class="menu-item" data-key="cosmic"><div class="menu-icon" style="background-image:linear-gradient(90deg,#b800e6,#6cedf0);"></div><div class="menu-label">Cosmic</div></div>
          <div class="menu-item" data-key="divine"><div class="menu-icon" style="background-image:linear-gradient(90deg,#ff00c8,#2248ff);"></div><div class="menu-label">Divine</div></div>
          <div class="menu-item" data-key="godly"><div class="menu-icon" style="background-image:linear-gradient(90deg,#7b00e6,#6367ff);"></div><div class="menu-label">Godly</div></div>
          <div class="menu-item" data-key="exclusive"><div class="menu-icon" style="background-image:linear-gradient(90deg,#00d1ff,#4fe0a3);"></div><div class="menu-label">Exclusive</div></div>
          <div class="menu-item" data-key="mythic"><div class="menu-icon" style="background-image:linear-gradient(90deg,#ff6d68,#ffb86b);"></div><div class="menu-label">Mythic</div></div>
          <div class="menu-item" data-key="legendary"><div class="menu-icon" style="background-image:linear-gradient(90deg,#ffd54a,#ff7a00);"></div><div class="menu-label">Legendary</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- list -->
  <div id="list-root" class="list-root" aria-live="polite"></div>

  <!-- pagination area -->
  <div id="pagination" style="display:flex;gap:12px;justify-content:center;margin-top:12px">
    <button id="prev-btn" style="padding:8px 12px;border-radius:8px;background:var(--card);border:1px solid var(--border);color:var(--text)">Previous</button>
    <div id="page-info" style="color:var(--muted);align-self:center">Page 1 of 1</div>
    <button id="next-btn" style="padding:8px 12px;border-radius:8px;background:var(--card);border:1px solid var(--border);color:var(--text)">Next</button>
  </div>

  <!-- picker & trait chooser (kept simple) -->
  <div id="picker-overlay" class="picker-overlay" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999;padding:12px">
    <div class="picker-box" style="width:100%;max-width:1180px;max-height:80vh;border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.006),rgba(255,255,255,0.003));border:1px solid var(--border);display:flex;gap:12px">
      <div id="picker-sidebar" style="width:160px;display:flex;flex-direction:column;gap:10px;overflow:auto"></div>
      <div style="flex:1;display:flex;flex-direction:column;gap:10px;padding:6px">
        <input id="picker-search-input" placeholder="SEARCH UNITS..." style="padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--border);color:var(--text)"/>
        <div id="picker-grid" style="flex:1;overflow:auto;display:grid;grid-template-columns:repeat(auto-fill,78px);gap:12px;padding:8px"></div>
      </div>
    </div>
  </div>

  <div id="trait-overlay" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:10010">
    <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid var(--border);min-width:320px">
      <div style="font-weight:900">Choose trait</div>
      <div id="trait-list" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px"></div>
      <div style="text-align:right;margin-top:10px"><button id="trait-cancel" style="padding:8px;border-radius:8px;background:var(--panel);border:1px solid var(--border);color:var(--text)">Cancel</button></div>
    </div>
  </div>

  <script src="skibidi-td-data.js"></script>

  <script>
  (function(){
    'use strict';
    // small helpers
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const parseValue = v => {
      if (v === 0) return 0;
      if (!v && v !== 0) return 0;
      let s = String(v).trim().replace(/[\$\€\£\¥\₹]/g,'').replace(/\s+/g,'');
      const m = s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/);
      if (m) { let n = parseFloat(m[1].replace(/,/g,''))||0; const sx = m[2]; if (sx){ if (sx.toLowerCase()==='k') n*=1e3; if (sx.toLowerCase()==='m') n*=1e6; } return n; }
      const f = s.match(/[\d.]+/); return f ? parseFloat(f[0].replace(/,/g,'')) : 0;
    };
    const abbr = n => { if (!isFinite(n)||n===0) return '0'; if (n>=1e6) return (n/1e6).toFixed(2)+'M+'; if (n>=1e3) return (n/1e3).toFixed(2)+'K'; return Math.round(n).toLocaleString(); };

    if (typeof unitDatabase === 'undefined' || !unitDatabase) { alert('unitDatabase missing'); return; }
    const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";
    const unitKeys = Object.keys(unitDatabase).sort((a,b)=> (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||''));
    const LS_KEY = 'skibidi_three_dot_v1';

    // state
    let currentFilter = 'all', searchQuery = '', currentSort = 'default', currentPage = 1;
    let itemsPerPage = (window.innerWidth <= 900) ? 8 : 15;
    const rarityOrder = { astral:1, cosmic:2, godly:3, divine:4, mythic:5, legendary:6, exclusive:99 };
    let leftItems = [], rightItems = [];
    let currentPickerSide = 'left', pendingPickerKey = null;

    // DOM refs
    const menuBtn = document.getElementById('menu-btn');
    const menuPanel = document.getElementById('menu-panel');
    const listRoot = document.getElementById('list-root');
    const pickerOverlay = document.getElementById('picker-overlay');
    const pickerSidebar = document.getElementById('picker-sidebar');
    const pickerGrid = document.getElementById('picker-grid');
    const pickerSearch = document.getElementById('picker-search-input');

    const leftItemsEl = document.getElementById('left-items');
    const rightItemsEl = document.getElementById('right-items');
    const leftTotalEl = document.getElementById('left-total');
    const rightTotalEl = document.getElementById('right-total');
    const verdictText = document.getElementById('verdict-text');

    const traitOverlay = document.getElementById('trait-overlay');
    const traitList = document.getElementById('trait-list');
    const traitCancel = document.getElementById('trait-cancel');

    function statusClass(status){
      if(!status) return 'status-default';
      const s = String(status).toLowerCase();
      if (/stable/.test(s)) return 'status-stable';
      if (/high demand|highdemand/.test(s)) return 'status-high-demand';
      if (/hyped|hype/.test(s)) return 'status-hyped';
      if (/drop|dropp/.test(s)) return 'status-dropping';
      if (/unstable/.test(s)) return 'status-unstable';
      return 'status-default';
    }
    function demandClass(d){
      if(!d) return 'demand-low';
      const m = String(d).match(/(\d+)/);
      const v = m?Number(m[1]):0;
      if (v >= 8) return 'demand-high';
      if (v >= 4) return 'demand-mid';
      return 'demand-low';
    }

    // render list
    function renderList(){
      const keys = unitKeys.filter(k=>{
        const u = unitDatabase[k];
        const r = (u.rarity||'').toLowerCase();
        if (currentFilter !== 'all' && r !== currentFilter) return false;
        if (searchQuery && !(u.name||'').toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
      });

      keys.sort((a,b)=>{
        if (currentSort === 'value-desc') return parseValue(unitDatabase[b].baseStats.value) - parseValue(unitDatabase[a].baseStats.value);
        const wa = rarityOrder[(unitDatabase[a].rarity||'').toLowerCase()]||999;
        const wb = rarityOrder[(unitDatabase[b].rarity||'').toLowerCase()]||999;
        if (wa !== wb) return wa - wb;
        return (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||'');
      });

      const totalPages = Math.max(1, Math.ceil(keys.length / itemsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage -1)*itemsPerPage;
      const pageKeys = keys.slice(start, start + itemsPerPage);

      document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prev-btn').disabled = currentPage === 1;
      document.getElementById('next-btn').disabled = currentPage === totalPages;

      listRoot.innerHTML = pageKeys.map(k=>{
        const u = unitDatabase[k];
        const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
        const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-');
        const st = statusClass(u.baseStats.status);
        const dm = demandClass(u.baseStats.demand);
        const second = u.secondEdition && String(u.secondEdition).toLowerCase() === 'yes' ? `<div style="color:#ffd54a;font-weight:900;margin-top:6px">2nd Edition</div>` : '';
        return `<div class="unit-card ${rcls}" data-key="${k}">
          <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
            <div class="unit-title">${esc(u.name)}</div>
            <div class="portrait ${rcls}"><div class="img" style="background-image:${p}"></div></div>
            ${second}
          </div>
          <div class="info-row">
            <div class="info-box value-box"><div class="label">Value</div><div class="value">${esc(u.baseStats.value)}</div></div>
            <div class="info-box"><div class="label">Status</div><div class="value"><span class="status-badge ${st}">${esc(u.baseStats.status)}</span></div></div>
            <div class="info-box"><div class="label">Demand</div><div class="value"><span class="demand-pill ${dm}">${esc(u.baseStats.demand)}</span></div></div>
          </div>
        </div>`; }).join('');
    }

    // three-dot menu wiring (open/close + item clicks)
    menuBtn.addEventListener('click', (e)=>{
      const open = menuPanel.style.display === 'block';
      menuPanel.style.display = open ? 'none' : 'block';
      menuPanel.setAttribute('aria-hidden', open ? 'true' : 'false');
    });
    document.addEventListener('click', (e)=>{
      if (!menuBtn.contains(e.target) && !menuPanel.contains(e.target)) { menuPanel.style.display='none'; menuPanel.setAttribute('aria-hidden','true'); }
    });

    // menu items already in markup: wire clicks
    menuPanel.querySelectorAll('.menu-item').forEach(it=>{
      it.addEventListener('click', ()=>{
        const key = it.getAttribute('data-key');
        // close menu
        menuPanel.style.display = 'none';
        if (key === 'calculator') {
          document.getElementById('calculator-root').style.display = 'block';
          listRoot.style.display = 'none';
          document.getElementById('pagination').style.display = 'none';
        } else {
          document.getElementById('calculator-root').style.display = 'none';
          listRoot.style.display = '';
          document.getElementById('pagination').style.display = 'flex';
          currentFilter = key || 'all';
          currentPage = 1; renderList();
        }
      });
    });

    // picker functions (no drag-drop)
    function createPicker(){
      const cats = ['Astral','Cosmic','Divine','Godly','Exclusive','Mythic','Legendary'];
      pickerSidebar.innerHTML = cats.map(c=>`<div class="picker-cat" data-cat="${c.toLowerCase()}">${c}</div>`).join('');
      const def = pickerSidebar.querySelector('[data-cat="astral"]'); if(def) def.classList.add('active');
      renderPickerGrid('astral','',1,'astral','');
      pickerSidebar.querySelectorAll('.picker-cat').forEach(b=>{
        b.addEventListener('click', ()=>{
          pickerSidebar.querySelectorAll('.picker-cat').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          const cat = b.getAttribute('data-cat') || 'astral';
          renderPickerGrid(cat,'',1,cat,pickerSearch.value||'');
        });
      });
      pickerSearch.removeEventListener('input', onPickerSearch);
      pickerSearch.addEventListener('input', onPickerSearch);
      pickerOverlay.addEventListener('click', (ev)=>{ if (ev.target === pickerOverlay) hidePicker(); });
    }
    function onPickerSearch(e){ const active = pickerSidebar.querySelector('.picker-cat.active'); const cat = active ? active.getAttribute('data-cat') : 'astral'; renderPickerGrid(cat,'',1,cat,e.target.value||''); }

    function renderPickerGrid(side, trait, qty, category, q){
      category = (category || 'astral').toLowerCase(); q = (q||'').toLowerCase();
      const keys = unitKeys.filter(k=>{
        const u = unitDatabase[k];
        if (!u) return false;
        if ((u.rarity||'').toLowerCase() !== category) return false;
        if (q && !(u.name||'').toLowerCase().includes(q)) return false;
        return true;
      });
      if (!keys.length) { pickerGrid.innerHTML=''; return; }
      pickerGrid.innerHTML = keys.map(k=>{ const u = unitDatabase[k]; const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : ''; const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-'); return `<div class="picker-thumb rarity-${rcls}" data-key="${k}" style="width:78px;height:78px;border-radius:10px;background:var(--panel);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border)"><div style="width:68px;height:68px;border-radius:8px;background-image:${p};background-size:cover;background-position:center"></div></div>`; }).join('');
      pickerGrid.querySelectorAll('.picker-thumb').forEach(t=>{ t.removeEventListener('click', onPickerClick); t.addEventListener('click', onPickerClick); });
    }

    function onPickerClick(e){ const key = e.currentTarget.getAttribute('data-key'); if (!key) return; pendingPickerKey = key; openTraitChooser(key); }

    function openTraitChooser(key){
      traitList.innerHTML = '';
      const base = [{id:'clean',label:'Clean'},{id:'normal',label:'Normal'}];
      base.forEach(b=>{ const btn = document.createElement('button'); btn.className='trait-btn'; btn.textContent=b.label; btn.addEventListener('click', ()=> onTraitChosen(b.id)); traitList.appendChild(btn); });
      const u = unitDatabase[key]; if (u && u.traits) Object.keys(u.traits).forEach(tr=>{ const btn = document.createElement('button'); btn.className='trait-btn'; btn.textContent=tr; btn.addEventListener('click', ()=> onTraitChosen(tr)); traitList.appendChild(btn); });
      traitOverlay.style.display='flex';
      traitCancel.removeEventListener('click', onTraitCancel);
      traitCancel.addEventListener('click', onTraitCancel, { once:true });
    }
    function onTraitCancel(){ traitOverlay.style.display='none'; pendingPickerKey=null; }
    function onTraitChosen(trait){
      if (!pendingPickerKey) { traitOverlay.style.display='none'; return; }
      const side = currentPickerSide || 'left';
      addToSide(side, pendingPickerKey, trait, 1);
      pendingPickerKey = null;
      traitOverlay.style.display='none';
      hidePicker();
    }

    function showPicker(){ pickerOverlay.style.display='flex'; document.body.style.overflow='hidden'; }
    function hidePicker(){ pickerOverlay.style.display='none'; document.body.style.overflow=''; }

    // calculator add/remove and render
    function calcThumbHTML(it){
      const u = unitDatabase[it.key] || {};
      const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
      const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-');
      const soap = it.clean ? `<div class="soap-badge">SOAP</div>` : '';
      return `<div class="calc-thumb rarity-${rcls}" data-id="${it.id}">${soap}<div class="img" style="background-image:${p}"></div><div class="thumb-remove" data-id="${it.id}" style="position:absolute;left:6px;top:6px;background:rgba(0,0,0,0.6);padding:3px 6px;color:#fff;border-radius:8px;cursor:pointer">×</div></div>`;
    }
    function renderThumbs(){ leftItemsEl.innerHTML = leftItems.map(calcThumbHTML).join(''); rightItemsEl.innerHTML = rightItems.map(calcThumbHTML).join(''); document.querySelectorAll('.thumb-remove').forEach(b=>{ b.removeEventListener('click', onThumbRemove); b.addEventListener('click', onThumbRemove); }); }
    function onThumbRemove(e){ const id = e.currentTarget.getAttribute('data-id'); let idx = leftItems.findIndex(x=>x.id===id); if (idx>=0) leftItems.splice(idx,1); idx = rightItems.findIndex(x=>x.id===id); if (idx>=0) rightItems.splice(idx,1); persistTrade(); renderThumbs(); updateTotalsAndVerdict(); }
    function addToSide(side,key,trait,qty){
      if (!key || !unitDatabase[key]) return; qty = Math.max(1, Math.floor(qty)||1); const u = unitDatabase[key];
      const single = (trait && trait !== 'normal' && trait !== 'clean' && u.traits && u.traits[trait]) ? parseValue(u.traits[trait].value) : parseValue(u.baseStats.value);
      const item = { id:`${key}:${trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key, trait, qty, single, computed: single * qty, clean: trait === 'clean' };
      if (side === 'left') leftItems.push(item); else rightItems.push(item);
      persistTrade(); renderThumbs(); updateTotalsAndVerdict();
    }
    function updateTotalsAndVerdict(){ leftItems.forEach(i=>i.computed=(i.single||0)*(i.qty||1)); rightItems.forEach(i=>i.computed=(i.single||0)*(i.qty||1)); const leftSum = leftItems.reduce((s,i)=>s+Number(i.computed||0),0); const rightSum = rightItems.reduce((s,i)=>s+Number(i.computed||0),0); leftTotalEl.textContent=`TOTAL VALUE: ${abbr(leftSum)}`; rightTotalEl.textContent=`TOTAL VALUE: ${abbr(rightSum)}`; const FAIR=0.02,SMALL=0.10; let verdict='NO ITEMS'; if (leftSum===0 && rightSum===0) verdict='NO ITEMS'; else if (Math.abs(leftSum-rightSum) <= Math.max(1,FAIR*Math.max(leftSum,rightSum))) verdict='FAIR'; else if (leftSum>rightSum){ if (rightSum===0 || leftSum>rightSum*(1+SMALL)) verdict='OVERPAYING'; else verdict='LOSE'; } else { if (leftSum===0 || rightSum>leftSum*(1+SMALL)) verdict='UNDERPAYING'; else verdict='WIN'; } verdictText.textContent = verdict.toUpperCase(); }

    function persistTrade(){ try{ const payload = { left:leftItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty,clean:!!i.clean})), right:rightItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty,clean:!!i.clean})) }; localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(e){ console.warn(e); } }
    function restoreTrade(){ try{ const raw = localStorage.getItem(LS_KEY); if (!raw) return; const p = JSON.parse(raw); leftItems = (p.left||[]).map(it=>{ const single = (it.trait && it.trait!=='normal' && it.trait!=='clean' && unitDatabase[it.key] && unitDatabase[it.key].traits && unitDatabase[it.key].traits[it.trait]) ? parseValue(unitDatabase[it.key].traits[it.trait].value) : parseValue((unitDatabase[it.key] && unitDatabase[it.key].baseStats && unitDatabase[it.key].baseStats.value) || 0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!it.clean }; }); rightItems = (p.right||[]).map(it=>{ const single = (it.trait && it.trait!=='normal' && it.trait!=='clean' && unitDatabase[it.key] && unitDatabase[it.key].traits && unitDatabase[it.key].traits[it.trait]) ? parseValue(unitDatabase[it.key].traits[it.trait].value) : parseValue((unitDatabase[it.key] && unitDatabase[it.key].baseStats && unitDatabase[it.key].baseStats.value) || 0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!it.clean }; }); } catch(e){ console.warn(e); } }

    // pagination + search + sort handlers
    document.getElementById('prev-btn').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; renderList(); window.scrollTo({top:0,behavior:'smooth'}); }});
    document.getElementById('next-btn').addEventListener('click', ()=>{ const keys = unitKeys.filter(k=>{ const u = unitDatabase[k]; const r = (u.rarity||'').toLowerCase(); if (currentFilter !== 'all' && r !== currentFilter) return false; if (searchQuery && !(u.name||'').toLowerCase().includes(searchQuery.toLowerCase())) return false; return true; }); const maxp = Math.ceil(keys.length/itemsPerPage)||1; if (currentPage < maxp){ currentPage++; renderList(); window.scrollTo({top:0,behavior:'smooth'}); }});
    document.getElementById('search-bar').addEventListener('input', e=>{ searchQuery = e.target.value || ''; currentPage = 1; renderList(); });

    // wire menu click events (already wired via markup)
    // wire example: also allow clicking visible category buttons
    document.querySelectorAll('.top-row .cat-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.top-row .cat-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const r = btn.getAttribute('data-rarity') || 'all';
        if (r === 'calculator') { document.getElementById('calculator-root').style.display = 'block'; listRoot.style.display = 'none'; document.getElementById('pagination').style.display='none'; }
        else { document.getElementById('calculator-root').style.display='none'; listRoot.style.display=''; document.getElementById('pagination').style.display='flex'; currentFilter = r; currentPage = 1; renderList(); }
      });
    });

    // picker openers - simple
    document.getElementById('plus-left').addEventListener('click', ()=>{ currentPickerSide='left'; createPicker(); showPicker(); });
    document.getElementById('plus-right').addEventListener('click', ()=>{ currentPickerSide='right'; createPicker(); showPicker(); });

    // init
    try {
      restoreTrade();
      renderList();
      renderThumbs();
      updateTotalsAndVerdict();
    } catch(e){ console.error('init error', e); }

    // expose for debug
    window._skibidi = { unitDatabase, leftItems, rightItems, renderList, renderThumbs, updateTotalsAndVerdict };

  })();
  </script>
</body>
</html>
