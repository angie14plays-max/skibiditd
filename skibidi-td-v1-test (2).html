<script>
(function(){
  // Small helper utilities (safe, no globals)
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  if (typeof unitDatabase === 'undefined') {
    console.warn('skibidi: unitDatabase not found — modal attach skipped.');
    return;
  }

  // Find trait-overlay container in your markup (must exist)
  const traitOverlay = document.getElementById('trait-overlay');
  if (!traitOverlay) {
    console.warn('skibidi: #trait-overlay not found — modal attach skipped.');
    return;
  }

  // Try to find a "currentPickerSide"-like value exposed by your scripts (prefer existing)
  const detectSide = () => {
    if (window.currentPickerSide) return window.currentPickerSide;
    if (window._skibidi && window._skibidi.currentPickerSide) return window._skibidi.currentPickerSide;
    if (window._skibidi_calc && window._skibidi_calc.currentPickerSide) return window._skibidi_calc.currentPickerSide;
    // fallback to left
    return 'left';
  };

  // Safe call into existing calculator-add function(s) or dispatch an event
  function callAddToSide(side, key, trait, qty) {
    // Normalize qty to integer >=1
    qty = Math.max(1, Math.floor(Number(qty) || 1));
    if (window._skibidi && typeof window._skibidi.addToSide === 'function') {
      try { window._skibidi.addToSide(side, key, trait, qty); return true; } catch(e){ console.warn(e); }
    }
    if (window._skibidi_calc && typeof window._skibidi_calc.addToSide === 'function') {
      try { window._skibidi_calc.addToSide(side, key, trait, qty); return true; } catch(e){ console.warn(e); }
    }
    if (typeof addToSide === 'function') {
      try { addToSide(side, key, trait, qty); return true; } catch(e){ console.warn(e); }
    }
    // fallback: dispatch custom event with details; other code can listen for this
    try {
      window.dispatchEvent(new CustomEvent('skibidi:addToSide', { detail: { side, key, trait, qty } }));
      return true;
    } catch(e){ console.warn(e); }
    return false;
  }

  // Build modal HTML (quantity field, trait radios, unit demand, add button)
  function buildModalContent(unitKey) {
    const u = unitDatabase[unitKey];
    const demand = (u && u.baseStats && u.baseStats.demand) ? u.baseStats.demand : '';
    // Gather trait keys: base Normal/Clean + unit-specific traits
    const traitKeys = ['normal','clean'];
    if (u && u.traits) {
      const extra = Object.keys(u.traits).filter(t=>t && !traitKeys.includes(t.toLowerCase()));
      traitKeys.push(...extra);
    }
    // Build trait radio list
    const traitRadiosHtml = traitKeys.map(t=>{
      const id = 'trait_' + Math.random().toString(36).slice(2,8);
      const label = (t.toLowerCase() === 'clean') ? 'Clean' : (t.toLowerCase() === 'normal') ? 'Normal' : t;
      return `<label style="display:inline-flex;gap:8px;align-items:center;cursor:pointer;margin:6px 8px">
                <input type="radio" name="sk_trait" value="${esc(t)}" ${t==='normal'?'checked':''}/>
                <span style="font-weight:900">${esc(label)}</span>
              </label>`;
    }).join('');
    // Full modal HTML (keeps simple inline styles to match your look)
    const html = `
      <div style="width:100%;max-width:520px;display:flex;flex-direction:column;gap:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900;font-size:18px;text-transform:uppercase">Enter Quantity</div>
          <button id="sk_modal_close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer">×</button>
        </div>

        <div>
          <input id="sk_qty_input" type="number" min="1" value="1" style="width:100%;padding:12px;border-radius:10px;border:2px solid #4b2bd6;background:#0a0a0a;color:#fff;font-weight:900" placeholder="Quantity"/>
        </div>

        <div style="font-weight:900;color:#ddd">Traits</div>
        <div id="sk_trait_list" style="display:flex;flex-wrap:wrap;gap:8px">${traitRadiosHtml}</div>

        <div style="font-weight:700;color:#bbb">Demand: <span id="sk_demand">${esc(demand)}</span></div>

        <div style="display:flex;justify-content:center;">
          <button id="sk_modal_add" style="padding:12px 22px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);border:2px solid rgba(255,255,255,0.05);color:#000;font-weight:900;cursor:pointer">Add</button>
        </div>
      </div>
    `;
    return html;
  }

  // Open trait-overlay modal for a unit (called when user clicks unit)
  function openCalculatorModalForUnit(unitKey) {
    // populate trait-overlay
    traitOverlay.innerHTML = ''; // clear existing
    traitOverlay.style.display = 'flex';
    traitOverlay.style.justifyContent = 'center';
    traitOverlay.style.alignItems = 'center';
    traitOverlay.innerHTML = `<div style="padding:14px;max-width:560px;width:100%">${buildModalContent(unitKey)}</div>`;

    // wire close button
    $('#sk_modal_close')?.addEventListener('click', ()=>{ traitOverlay.style.display='none'; });
    traitOverlay.addEventListener('click', function onOutside(e){
      if (e.target === traitOverlay) { traitOverlay.style.display = 'none'; traitOverlay.removeEventListener('click', onOutside); }
    });

    // add handler for modal Add
    const addBtn = document.getElementById('sk_modal_add');
    addBtn && addBtn.addEventListener('click', ()=>{
      const qtyEl = document.getElementById('sk_qty_input');
      const qty = qtyEl ? Number(qtyEl.value) : 1;
      const sel = traitOverlay.querySelector('input[name="sk_trait"]:checked');
      const trait = sel ? sel.value : 'normal';
      const side = detectSide(); // left/right detection best-effort
      const ok = callAddToSide(side, unitKey, trait, qty);
      if (!ok) {
        alert('Add failed: calculator function not found. Open console for details.');
      }
      // close
      traitOverlay.style.display = 'none';
    });
  }

  // Attach click handlers to unit cards (existing .unit-card elements)
  function attachUnitClickHandlers() {
    // Use event delegation since list may be re-rendered
    document.addEventListener('click', function onDocClick(e){
      // if user clicked a unit card or any child inside
      const unitCard = e.target.closest('.unit-card');
      if (!unitCard) return;
      // ensure we don't act when clicking controls inside calculator etc.
      const key = unitCard.getAttribute('data-unit') || unitCard.getAttribute('data-key') || unitCard.getAttribute('data-keyname') || unitCard.getAttribute('data-key') ;
      // prefer data-unit attribute used in renderList
      const unitKey = unitCard.getAttribute('data-unit') || unitCard.getAttribute('data-key') || unitCard.getAttribute('data-id');
      if (!unitKey) return;
      // If calculator is visible open modal; otherwise do nothing (respect your workflow)
      const calcRoot = document.getElementById('calculator-root');
      if (calcRoot && calcRoot.style.display !== 'none' && calcRoot.style.display !== '') {
        // calculator root is shown (explicit style) — proceed
        openCalculatorModalForUnit(unitKey);
      } else {
        // if calculator is hidden, we still open modal but warn user
        openCalculatorModalForUnit(unitKey);
      }
    }, false);
  }

  // Small selector helpers used above (safe)
  function $(sel){ return document.querySelector(sel); }
  function $$(sel){ return Array.from(document.querySelectorAll(sel)); }

  // Start: attach handlers immediately for existing cards and future ones
  attachUnitClickHandlers();

  // Also re-run attach if your page re-renders list (optional)
  // If your code exposes window._skibidi or _skibidi.renderList, you can call attach again after render.
  // Example: if window._skibidi exists:
  if (window._skibidi && typeof window._skibidi.renderList === 'function') {
    const orig = window._skibidi.renderList;
    window._skibidi.renderList = function(){
      const r = orig.apply(this, arguments);
      setTimeout(() => attachUnitClickHandlers(), 40);
      return r;
    };
  }

  // Also listen for a custom event to trigger modal programmatically:
  window.addEventListener('skibidi:openAddModal', function(ev){
    const key = ev && ev.detail && ev.detail.key; if (key) openCalculatorModalForUnit(key);
  });

  console.log('skibidi: calculator modal enhancer loaded (safe)');

})();
</script>
