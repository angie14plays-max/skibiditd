<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skibidi TD — Fixed (menu categories + rarity colors + calculator)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050506;
      --card:#0f0f11;
      --panel:#111214;
      --box:#141618;
      --border:#232529;
      --muted:#9aa0a5;
      --text:#ffffff;
      --radius:12px;

      --g-astral: linear-gradient(90deg,#7f00ff,#00ffd5);
      --g-cosmic: linear-gradient(90deg,#b800e6,#6cedf0);
      --g-divine: linear-gradient(90deg,#ff00c8,#2248ff);
      --g-godly: linear-gradient(90deg,#7b00e6,#6367ff);
      --g-exclusive: linear-gradient(90deg,#00d1ff,#4fe0a3);
      --g-mythic: linear-gradient(90deg,#ff6d68,#ffb86b);
      --g-legendary: linear-gradient(90deg,#ffd54a,#ff7a00);

      --accent: linear-gradient(90deg,#8b4bff,#ff2d6f);
    }

    *{box-sizing:border-box;font-family:'Montserrat',sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    body{padding:22px;display:flex;flex-direction:column;align-items:center;gap:18px}

    .container{width:100%;max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:12px;align-items:center}

    /* Search + menu */
    .top-row{width:100%;display:flex;align-items:center;gap:12px;justify-content:space-between;position:relative}
    #search-bar{flex:1;padding:12px 16px;border-radius:22px;background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.02);color:var(--text);outline:none}
    .menu-btn{width:44px;height:44px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:grid;place-items:center;cursor:pointer}
    .menu-btn .dots{width:6px;height:6px;background:var(--muted);border-radius:50%;box-shadow:0 -10px 0 0 var(--muted),0 10px 0 0 var(--muted)}

    /* SMALL: keep menu button on small screens */
    .menu-btn{display:none}
    @media (max-width:600px){ .menu-btn{display:block} }

    /* menu panel */
    .menu-panel{position:absolute;right:22px;top:78px;min-width:300px;background:#fff;color:#000;border-radius:10px;box-shadow:0 30px 80px rgba(0,0,0,0.6);border:1px solid rgba(0,0,0,0.06);display:none;z-index:9999;overflow:hidden}
    .menu-section{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)}
    .menu-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;cursor:pointer}
    .menu-item:hover{background:rgba(0,0,0,0.04)}
    .menu-label{font-weight:700;text-transform:uppercase}

    /* uniform controls - made visible and styled as in screenshot */
    .controls-row { width:100%; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:6px; }
    .control-btn{
      padding:12px 20px;
      border-radius:14px;
      font-weight:900;
      text-transform:uppercase;
      background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.03));
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.03);
      min-width:120px;
      text-align:center;
      cursor:pointer;
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
      transition:all .12s ease;
    }
    .control-btn:hover{ color:#fff; transform:translateY(-2px); }
    .control-btn.active{ border-color:#ffd54a; color:#fff; box-shadow:0 0 0 6px rgba(255,213,74,0.06), 0 10px 40px rgba(0,0,0,0.6); }

    /* sort */
    .sort-row{display:flex;gap:12px;justify-content:center;margin-top:6px}
    .sort-btn{padding:12px 18px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.003));border:1px solid rgba(255,255,255,0.03);color:var(--muted);font-weight:900;cursor:pointer}
    .sort-btn.active{border-color:#ffd54a;color:#fff;box-shadow:0 0 0 6px rgba(255,213,74,0.06)}

    /* list grid */
    .list-root{width:100%;max-width:1200px;display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-top:12px}

    /* unit card with fixed header to align */
    .unit-card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.02));border-radius:var(--radius);padding:18px;border:1px solid var(--border);min-height:360px;display:flex;flex-direction:column;justify-content:space-between;overflow:visible}
    .card-header{height:190px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
    .unit-title{font-weight:900;text-transform:uppercase;font-size:16px;letter-spacing:0.6px;text-align:center}

    /* portrait frame + circle */
    .portrait-frame{width:132px;height:132px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.03);position:relative}
    .portrait-circle{width:110px;height:110px;border-radius:50%;background:var(--panel);display:flex;align-items:center;justify-content:center;border:3px solid rgba(0,0,0,0.6)}
    .portrait-circle .img{width:98px;height:98px;border-radius:50%;background-size:cover;background-position:center}

    /* rarity halo */
    .unit-card.rarity-astral .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-astral);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-cosmic .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-cosmic);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-divine .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-divine);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-godly .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-godly);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-exclusive .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-exclusive);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-mythic .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-mythic);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-legendary .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-legendary);z-index:-1;opacity:0.95;filter:blur(8px)}

    .unit-card.rarity-astral::after{content:'';position:absolute;inset:0;background:var(--g-astral);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-cosmic::after{content:'';position:absolute;inset:0;background:var(--g-cosmic);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-divine::after{content:'';position:absolute;inset:0;background:var(--g-divine);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-godly::after{content:'';position:absolute;inset:0;background:var(--g-godly);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-exclusive::after{content:'';position:absolute;inset:0;background:var(--g-exclusive);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-mythic::after{content:'';position:absolute;inset:0;background:var(--g-mythic);opacity:0.04;border-radius:var(--radius);pointer-events:none}
    .unit-card.rarity-legendary::after{content:'';position:absolute;inset:0;background:var(--g-legendary);opacity:0.04;border-radius:var(--radius);pointer-events:none}

    .info-row{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px}
    .info-box{min-width:120px;background:var(--panel);border-radius:10px;padding:12px 14px;text-align:center;border:1px solid var(--border)}
    .info-box .label{display:block;color:var(--muted);font-weight:800;font-size:11px;text-transform:uppercase}
    .info-box .value{display:block;font-weight:900;margin-top:6px}

    /* colored badges restored */
    .status-badge{padding:6px 10px;border-radius:8px;font-weight:900;text-transform:uppercase;font-size:12px;display:inline-block}
    .status-stable{background:linear-gradient(90deg,#f97316,#ffb86b);color:#2a1000}
    .status-high-demand{background:linear-gradient(90deg,#7c3aed,#a78bfa);color:#fff}
    .status-hyped{background:linear-gradient(90deg,#06b6d4,#7ef0f7);color:#021}
    .status-dropping{background:linear-gradient(90deg,#ef4444,#ff8a8a);color:#200}
    .status-unstable{background:linear-gradient(90deg,#9d174d,#ff95c9);color:#23020a}
    .status-recovering{background:linear-gradient(90deg,#65a30d,#bef264);color:#032}
    .status-default{background:linear-gradient(90deg,#6b7280,#9ca3af);color:#fff}

    .demand-pill{padding:6px 8px;border-radius:8px;font-weight:900;color:#fff}
    .demand-low{background:linear-gradient(90deg,#6b7280,#9ca3af)}
    .demand-mid{background:linear-gradient(90deg,#f97316,#ffb86b);color:#120}
    .demand-high{background:linear-gradient(90deg,#16a34a,#6fe89a);color:#012}

    /* calc thumbs */
    .calc-thumb{width:76px;height:76px;border-radius:10px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,0.04);background:var(--panel)}
    .calc-thumb .img{width:100%;height:100%;background-size:cover;background-position:center;border-radius:8px}
    .calc-thumb::before{content:'';position:absolute;inset:-6px;border-radius:12px;z-index:-1;opacity:0.98}
    .calc-thumb.rarity-astral::before{background:var(--g-astral)}
    .calc-thumb.rarity-cosmic::before{background:var(--g-cosmic)}
    .calc-thumb.rarity-divine::before{background:var(--g-divine)}
    .calc-thumb.rarity-godly::before{background:var(--g-godly)}
    .calc-thumb.rarity-exclusive::before{background:var(--g-exclusive)}
    .calc-thumb.rarity-mythic::before{background:var(--g-mythic)}
    .calc-thumb.rarity-legendary::before{background:var(--g-legendary)}

    .soap-badge{position:absolute;right:6px;top:6px;padding:4px 6px;border-radius:8px;background:linear-gradient(90deg,#fff7cc,#fff1a8);color:#3b2f00;font-weight:900;font-size:11px;z-index:4}

    /* picker */
    .picker-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999;padding:12px}
    .picker-box{width:100%;max-width:1180px;max-height:90vh;border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.006),rgba(255,255,255,0.003));border:1px solid var(--border);display:flex;gap:12px;overflow:hidden}
    .picker-sidebar{width:160px;display:flex;flex-direction:column;gap:10px;overflow:auto;padding:6px}
    .picker-cat{padding:12px;border-radius:10px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-weight:900;cursor:pointer}
    .picker-cat.active{outline:2px solid rgba(255,255,255,0.03);color:#fff; box-shadow:0 0 0 6px rgba(255,213,74,0.06); border-color:#ffd54a}
    .picker-grid{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,78px);gap:12px}

    .trait-btn{padding:8px 12px;border-radius:8px;background:var(--panel);color:var(--text);border:1px solid var(--border);font-weight:800;cursor:pointer;margin:6px}
    @media (max-width:1024px){ .list-root{grid-template-columns:repeat(2,1fr)} .picker-box{flex-direction:column} .picker-sidebar{width:100%;flex-direction:row;overflow:auto} }
    @media (max-width:600px){ .list-root{grid-template-columns:1fr} .card-header{height:170px} .portrait-frame{width:118px;height:118px} }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-row">
      <input id="search-bar" placeholder="Search unit..." aria-label="Search units" />
      <div style="display:flex;gap:12px;align-items:center">
        <div class="menu-btn" id="menu-btn" title="Menu"><div class="dots" aria-hidden="true"></div></div>
      </div>

      <div class="menu-panel" id="menu-panel" aria-hidden="true">
        <div class="menu-section">
          <div class="menu-item" data-key="calculator"><div class="menu-label">Calculator</div></div>
        </div>
        <div class="menu-section">
          <div class="menu-item" data-key="all"><div class="menu-label">All</div></div>
          <div class="menu-item" data-key="astral"><div class="menu-label">Astral</div></div>
          <div class="menu-item" data-key="cosmic"><div class="menu-label">Cosmic</div></div>
          <div class="menu-item" data-key="divine"><div class="menu-label">Divine</div></div>
          <div class="menu-item" data-key="godly"><div class="menu-label">Godly</div></div>
          <div class="menu-item" data-key="exclusive"><div class="menu-label">Exclusive</div></div>
          <div class="menu-item" data-key="mythic"><div class="menu-label">Mythic</div></div>
          <div class="menu-item" data-key="legendary"><div class="menu-label">Legendary</div></div>
        </div>
      </div>
    </div>

    <!-- Controls visible (restored like the screenshot) -->
    <div class="controls-row">
      <div class="control-btn active" data-rarity="all">All</div>
      <div class="control-btn" data-rarity="astral">Astral</div>
      <div class="control-btn" data-rarity="cosmic">Cosmic</div>
      <div class="control-btn" data-rarity="divine">Divine</div>
      <div class="control-btn" data-rarity="godly">Godly</div>
      <div class="control-btn" data-rarity="exclusive">Exclusive</div>
      <div class="control-btn" data-rarity="mythic">Mythic</div>
      <div class="control-btn" data-rarity="legendary">Legendary</div>
      <div class="control-btn" data-rarity="calculator">Calculator</div>
    </div>

    <div class="sort-row">
      <button class="sort-btn active" data-sort="default">Default Sort</button>
      <button class="sort-btn" data-sort="value-desc">High Value</button>
    </div>

    <div id="list-root" class="list-root"></div>

    <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px" id="pagination">
      <button id="prev-btn" class="sort-btn" style="min-width:120px">Previous</button>
      <div id="page-info" style="color:var(--muted)">Page 1 of 1</div>
      <button id="next-btn" class="sort-btn" style="min-width:120px">Next</button>
    </div>

    <!-- Calculator -->
    <div id="calculator-root" style="display:none;width:100%;max-width:1200px;margin-top:12px">
      <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center">
        <div style="width:46%;min-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.01));padding:18px;border-radius:12px;border:1px solid var(--border)">
          <div style="text-align:center;font-weight:900">YOUR VALUE</div>
          <div style="display:flex;justify-content:center;margin:12px 0"><button id="plus-left" class="control-btn" style="min-width:56px;height:56px;border-radius:12px">+</button></div>
          <div id="left-items" style="display:grid;grid-template-columns:repeat(auto-fill,76px);gap:8px;min-height:120px"></div>
          <div style="text-align:center;margin-top:12px"><span id="left-total" style="padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);color:#000;font-weight:900">TOTAL VALUE: 0</span></div>
        </div>

        <div style="width:46%;min-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.01));padding:18px;border-radius:12px;border:1px solid var(--border)">
          <div style="text-align:center;font-weight:900">THEIR VALUE</div>
          <div style="display:flex;justify-content:center;margin:12px 0"><button id="plus-right" class="control-btn" style="min-width:56px;height:56px;border-radius:12px">+</button></div>
          <div id="right-items" style="display:grid;grid-template-columns:repeat(auto-fill,76px);gap:8px;min-height:120px"></div>
          <div style="text-align:center;margin-top:12px"><span id="right-total" style="padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);color:#000;font-weight:900">TOTAL VALUE: 0</span></div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;margin-top:12px"><div id="verdict-text" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-weight:900;color:#6ea0ff">NO ITEMS</div></div>
    </div>

    <!-- Picker -->
    <div class="picker-overlay" id="picker-overlay" style="display:none">
      <div class="picker-box">
        <div id="picker-sidebar" class="picker-sidebar"></div>
        <div style="flex:1;display:flex;flex-direction:column;gap:10px">
          <input id="picker-search-input" placeholder="SEARCH UNITS..." style="padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--border);color:var(--text)"/>
          <div id="picker-grid" class="picker-grid"></div>
        </div>
      </div>
    </div>

    <!-- Trait chooser -->
    <div id="trait-overlay" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:10010">
      <div style="background:var(--card);padding:12px;border-radius:10px;border:1px solid var(--border);min-width:320px">
        <div style="font-weight:900">Choose trait</div>
        <div id="trait-list" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px"></div>
        <div style="text-align:right;margin-top:10px"><button id="trait-cancel" style="padding:8px 12px;border-radius:8px;background:var(--panel);border:1px solid var(--border);color:var(--text)">Cancel</button></div>
      </div>
    </div>

  </div><!-- container -->

<script src="skibidi-td-data.js"></script>
<script>
(function(){
  'use strict';
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const parseValue = v => { if (v===0) return 0; if (!v && v!==0) return 0; let s=String(v).trim().replace(/[\$\€\£\¥\₹]/g,'').replace(/\s+/g,''); const m=s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/); if(m){ let n=parseFloat(m[1].replace(/,/g,''))||0; const sx=m[2]; if(sx){ if(sx.toLowerCase()==='k') n*=1e3; if(sx.toLowerCase()==='m') n*=1e6;} return n; } const f=s.match(/[\d.]+/); return f?parseFloat(f[0].replace(/,/g,'')):0; };
  const abbr = n => { if(!isFinite(n)||n===0) return '0'; if(n>=1e6) return (n/1e6).toFixed(2)+'M+'; if(n>=1e3) return (n/1e3).toFixed(2)+'K'; return Math.round(n).toLocaleString(); };

  if (typeof unitDatabase === 'undefined' || !unitDatabase) { alert('unitDatabase missing'); return; }
  const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";
  const unitKeys = Object.keys(unitDatabase).sort((a,b)=> (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||''));
  const LS_KEY = 'skibidi_td_menu_colors';

  let currentFilter='all', searchQuery='', currentSort='default', currentPage=1;
  let itemsPerPage = (window.innerWidth<=900)?8:15;
  const rarityOrder = { astral:1, cosmic:2, godly:3, divine:4, mythic:5, legendary:6, exclusive:99 };

  let leftItems=[], rightItems=[];
  let currentPickerSide='left', pendingPickerKey=null;

  // refs
  const menuBtn = document.getElementById('menu-btn');
  const menuPanel = document.getElementById('menu-panel');
  const listRoot = document.getElementById('list-root');
  const pickerOverlay = document.getElementById('picker-overlay');
  const pickerSidebar = document.getElementById('picker-sidebar');
  const pickerGrid = document.getElementById('picker-grid');
  const pickerSearch = document.getElementById('picker-search-input');

  const leftItemsEl = document.getElementById('left-items');
  const rightItemsEl = document.getElementById('right-items');

  const traitOverlay = document.getElementById('trait-overlay');
  const traitList = document.getElementById('trait-list');
  const traitCancel = document.getElementById('trait-cancel');

  function statusClass(status){ if(!status) return 'status-default'; const s=String(status).toLowerCase(); if(/stable/.test(s)) return 'status-stable'; if(/high demand|highdemand/.test(s)) return 'status-high-demand'; if(/hyped|hype/.test(s)) return 'status-hyped'; if(/drop|dropp/.test(s)) return 'status-dropping'; if(/unstable/.test(s)) return 'status-unstable'; return 'status-default'; }
  function demandClass(d){ if(!d) return 'demand-low'; const m=String(d).match(/(\d+)/); const v=m?Number(m[1]):0; if(v>=8) return 'demand-high'; if(v>=4) return 'demand-mid'; return 'demand-low'; }

  function renderList(){
    const keys = unitKeys.filter(k=>{ const u=unitDatabase[k]; const r=(u.rarity||'').toLowerCase(); if(currentFilter!=='all' && r!==currentFilter) return false; if(searchQuery && !(u.name||'').toLowerCase().includes(searchQuery.toLowerCase())) return false; return true; });
    keys.sort((a,b)=>{ if(currentSort==='value-desc') return parseValue(unitDatabase[b].baseStats.value)-parseValue(unitDatabase[a].baseStats.value); const wa=rarityOrder[(unitDatabase[a].rarity||'').toLowerCase()]||999; const wb=rarityOrder[(unitDatabase[b].rarity||'').toLowerCase()]||999; if(wa!==wb) return wa-wb; return (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||''); });
    const totalPages = Math.max(1, Math.ceil(keys.length/itemsPerPage));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*itemsPerPage;
    const pageKeys = keys.slice(start, start+itemsPerPage);
    document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prev-btn').disabled = currentPage===1;
    document.getElementById('next-btn').disabled = currentPage===totalPages;

    listRoot.innerHTML = pageKeys.map(k=>{
      const u = unitDatabase[k];
      const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
      const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-');
      const st = statusClass(u.baseStats.status);
      const dm = demandClass(u.baseStats.demand);
      const second = u.secondEdition && String(u.secondEdition).toLowerCase()==='yes' ? `<div style="color:#ffd54a;font-weight:900;margin-top:6px">2nd Edition</div>` : '';
      return `<div class="unit-card ${rcls}" data-key="${k}">
        <div class="card-header">
          <div class="unit-title">${esc(u.name)}</div>
          <div class="portrait-frame"><div class="portrait-circle ${rcls}"><div class="img" style="background-image:${p}"></div></div></div>
          ${second}
        </div>
        <div class="info-row">
          <div class="info-box"><div class="label">Value</div><div class="value">${esc(u.baseStats.value)}</div></div>
          <div class="info-box"><div class="label">Status</div><div class="value"><span class="status-badge ${st}">${esc(u.baseStats.status)}</span></div></div>
          <div class="info-box"><div class="label">Demand</div><div class="value"><span class="demand-pill ${dm}">${esc(u.baseStats.demand)}</span></div></div>
        </div>
      </div>`; }).join('');
  }

  // menu (kept for small screens)
  menuBtn.addEventListener('click', ()=>{ const open = menuPanel.style.display==='block'; menuPanel.style.display = open ? 'none' : 'block'; menuPanel.setAttribute('aria-hidden', open ? 'true' : 'false'); });
  document.addEventListener('click', (e)=>{ if(!menuBtn.contains(e.target) && !menuPanel.contains(e.target)){ menuPanel.style.display='none'; menuPanel.setAttribute('aria-hidden','true'); } });
  menuPanel.querySelectorAll('.menu-item').forEach(it=>{ it.addEventListener('click', ()=>{ const key = it.getAttribute('data-key'); menuPanel.style.display='none'; if(key==='calculator'){ document.getElementById('calculator-root').style.display='block'; listRoot.style.display='none'; document.getElementById('pagination').style.display='none'; } else { document.getElementById('calculator-root').style.display='none'; listRoot.style.display=''; document.getElementById('pagination').style.display='flex'; currentFilter = key || 'all'; currentPage = 1; updateControlActiveFromFilter(); renderList(); } }); });

  // sort
  document.querySelectorAll('.sort-btn').forEach(b=>{ b.addEventListener('click', ()=>{ document.querySelectorAll('.sort-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); currentSort = b.getAttribute('data-sort')||'default'; currentPage = 1; renderList(); }); });

  // pagination & search
  document.getElementById('prev-btn').addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderList(); window.scrollTo({top:0,behavior:'smooth'}); }});
  document.getElementById('next-btn').addEventListener('click', ()=>{ const keys = unitKeys.filter(k=>{ const u=unitDatabase[k]; const r=(u.rarity||'').toLowerCase(); if(currentFilter!=='all' && r!==currentFilter) return false; if(searchQuery && !(u.name||'').toLowerCase().includes(searchQuery.toLowerCase())) return false; return true; }); const maxp = Math.ceil(keys.length/itemsPerPage)||1; if(currentPage<maxp){ currentPage++; renderList(); window.scrollTo({top:0,behavior:'smooth'}); }});
  document.getElementById('search-bar').addEventListener('input', e=>{ searchQuery = e.target.value || ''; currentPage = 1; renderList(); });

  // Controls row (restored UI controls like the screenshot)
  const controlButtons = Array.from(document.querySelectorAll('.control-btn'));
  controlButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      controlButtons.forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      const r = btn.getAttribute('data-rarity');
      if(r === 'calculator'){
        document.getElementById('calculator-root').style.display='block';
        listRoot.style.display='none';
        document.getElementById('pagination').style.display='none';
      } else {
        document.getElementById('calculator-root').style.display='none';
        listRoot.style.display='';
        document.getElementById('pagination').style.display='flex';
        currentFilter = r || 'all';
        currentPage = 1;
        renderList();
      }
    });
  });

  function updateControlActiveFromFilter(){
    controlButtons.forEach(b=>{
      const r = b.getAttribute('data-rarity');
      if(r===currentFilter){ b.classList.add('active'); } else { b.classList.remove('active'); }
    });
    // ensure calculator button not marked active when filter set
    const calcBtn = document.querySelector('.control-btn[data-rarity="calculator"]');
    if(calcBtn) calcBtn.classList.remove('active');
  }

  // picker functions
  function createPicker(){
    const cats=['Astral','Cosmic','Divine','Godly','Exclusive','Mythic','Legendary'];
    pickerSidebar.innerHTML = cats.map(c=>`<div class="picker-cat" data-cat="${c.toLowerCase()}">${c}</div>`).join('');
    const def = pickerSidebar.querySelector('[data-cat="astral"]'); if(def) def.classList.add('active');
    renderPickerGrid('astral','',1,'astral','');
    pickerSidebar.querySelectorAll('.picker-cat').forEach(btn=>{ btn.addEventListener('click', ()=>{ pickerSidebar.querySelectorAll('.picker-cat').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderPickerGrid(btn.getAttribute('data-cat')||'astral','','',btn.getAttribute('data-cat')||'astral'); }); });
    pickerSearch.removeEventListener('input', onPickerSearch); pickerSearch.addEventListener('input', onPickerSearch);
    pickerOverlay.addEventListener('click', (ev)=>{ if(ev.target===pickerOverlay) hidePicker(); });
  }
  function onPickerSearch(e){ const active = pickerSidebar.querySelector('.picker-cat.active'); const cat = active?active.getAttribute('data-cat'):'astral'; renderPickerGrid(cat,'',1,cat,e.target.value||''); }
  function renderPickerGrid(side,trait,qty,category,q){
    category=(category||'astral').toLowerCase(); q=(q||'').toLowerCase();
    const keys = unitKeys.filter(k=>{ const u=unitDatabase[k]; if(!u) return false; if((u.rarity||'').toLowerCase() !== category) return false; if(q && !(u.name||'').toLowerCase().includes(q)) return false; return true; });
    if(!keys.length){ pickerGrid.innerHTML=''; return; }
    pickerGrid.innerHTML = keys.map(k=>{ const u=unitDatabase[k]; const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : ''; const rcls=(u.rarity||'').toLowerCase().replace(/\s+/g,'-'); return `<div class="picker-thumb rarity-${rcls}" data-key="${k}"><div style="width:68px;height:68px;border-radius:8px;background-image:${p};background-size:cover;background-position:center"></div></div>`; }).join('');
    pickerGrid.querySelectorAll('.picker-thumb').forEach(t=>{ t.removeEventListener('click', onPickerClick); t.addEventListener('click', onPickerClick); });
  }
  function onPickerClick(e){ const key=e.currentTarget.getAttribute('data-key'); if(!key) return; pendingPickerKey = key; openTraitChooser(key); }
  function openTraitChooser(key){ traitList.innerHTML=''; const base=[{id:'clean',label:'Clean'},{id:'normal',label:'Normal'}]; base.forEach(b=>{ const btn=document.createElement('button'); btn.className='trait-btn'; btn.textContent=b.label; btn.addEventListener('click', ()=>{ addToSide(currentPickerSide,key,b.id,1); traitOverlay.style.display='none'; hidePicker(); }); traitList.appendChild(btn); }); const u=unitDatabase[key]; if(u && u.traits) Object.keys(u.traits).forEach(tr=>{ const btn=document.createElement('button'); btn.className='trait-btn'; btn.textContent=tr; btn.addEventListener('click', ()=>{ addToSide(currentPickerSide,key,tr,1); traitOverlay.style.display='none'; hidePicker(); }); traitList.appendChild(btn); }); traitOverlay.style.display='flex'; traitCancel.removeEventListener('click', ()=>{}); traitCancel.addEventListener('click', ()=>{ traitOverlay.style.display='none'; pendingPickerKey=null; }, { once:true }); }
  function showPicker(){ pickerOverlay.style.display='flex'; document.body.style.overflow='hidden'; }
  function hidePicker(){ pickerOverlay.style.display='none'; document.body.style.overflow=''; }

  // calculator add/remove
  function calcThumbHTML(it){ const u=unitDatabase[it.key]||{}; const p=u.unitId?`url('${imageProvider}${u.unitId}')`:''; const rcls=(u.rarity||'').toLowerCase().replace(/\s+/g,'-'); const soap = it.clean?'<div class="soap-badge">SOAP</div>':''; return `<div class="calc-thumb rarity-${rcls}" data-id="${it.id}">${soap}<div class="img" style="background-image:${p}"></div><div class="thumb-remove" data-id="${it.id}" style="position:absolute;left:6px;top:6px;background:rgba(0,0,0,0.6);padding:3px 6px;color:#fff;border-radius:8px;cursor:pointer">×</div></div>`; }
  function renderThumbs(){ leftItemsEl.innerHTML = leftItems.map(calcThumbHTML).join(''); rightItemsEl.innerHTML = rightItems.map(calcThumbHTML).join(''); document.querySelectorAll('.thumb-remove').forEach(b=>{ b.removeEventListener('click', onThumbRemove); b.addEventListener('click', onThumbRemove); }); }
  function onThumbRemove(e){ const id=e.currentTarget.getAttribute('data-id'); let idx=leftItems.findIndex(x=>x.id===id); if(idx>=0) leftItems.splice(idx,1); idx=rightItems.findIndex(x=>x.id===id); if(idx>=0) rightItems.splice(idx,1); persistTrade(); renderThumbs(); updateTotalsAndVerdict(); }
  function addToSide(side,key,trait,qty){ if(!key||!unitDatabase[key]) return; qty=Math.max(1,Math.floor(qty)||1); const u=unitDatabase[key]; const single=(trait && trait!=='normal' && trait!=='clean' && u.traits && u.traits[trait])?parseValue(u.traits[trait].value):parseValue(u.baseStats.value); const item={ id:`${key}:${trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key, trait, qty, single, computed: single*qty, clean: trait==='clean' }; if(side==='left') leftItems.push(item); else rightItems.push(item); persistTrade(); renderThumbs(); updateTotalsAndVerdict(); }
  function updateTotalsAndVerdict(){ leftItems.forEach(i=>i.computed=(i.single||0)*(i.qty||1)); rightItems.forEach(i=>i.computed=(i.single||0)*(i.qty||1)); const leftSum=leftItems.reduce((s,i)=>s+Number(i.computed||0),0); const rightSum=rightItems.reduce((s,i)=>s+Number(i.computed||0),0); document.getElementById('left-total').textContent=`TOTAL VALUE: ${abbr(leftSum)}`; document.getElementById('right-total').textContent=`TOTAL VALUE: ${abbr(rightSum)}`; const FAIR=0.02,SMALL=0.10; let verdict='NO ITEMS'; if(leftSum===0 && rightSum===0) verdict='NO ITEMS'; else if(Math.abs(leftSum-rightSum)<=Math.max(1,FAIR*Math.max(leftSum,rightSum))) verdict='FAIR'; else if(leftSum>rightSum){ if(rightSum===0 || leftSum>rightSum*(1+SMALL)) verdict='OVERPAYING'; else verdict='LOSE'; } else { if(leftSum===0 || rightSum>leftSum*(1+SMALL)) verdict='UNDERPAYING'; else verdict='WIN'; } document.getElementById('verdict-text').textContent=verdict.toUpperCase(); }

  function persistTrade(){ try{ const payload={ left:leftItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty,clean:!!i.clean})), right:rightItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty,clean:!!i.clean})) }; localStorage.setItem(LS_KEY,JSON.stringify(payload)); }catch(e){console.warn(e);} }
  function restoreTrade(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const p=JSON.parse(raw); leftItems=(p.left||[]).map(it=>{ const single=(it.trait && it.trait!=='normal' && it.trait!=='clean' && unitDatabase[it.key] && unitDatabase[it.key].traits && unitDatabase[it.key].traits[it.trait])?parseValue(unitDatabase[it.key].traits[it.trait].value):parseValue((unitDatabase[it.key] && unitDatabase[it.key].baseStats && unitDatabase[it.key].baseStats.value)||0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!it.clean }; }); rightItems=(p.right||[]).map(it=>{ const single=(it.trait && it.trait!=='normal' && it.trait!=='clean' && unitDatabase[it.key] && unitDatabase[it.key].traits && unitDatabase[it.key].traits[it.trait])?parseValue(unitDatabase[it.key].traits[it.trait].value):parseValue((unitDatabase[it.key] && unitDatabase[it.key].baseStats && unitDatabase[it.key].baseStats.value)||0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!it.clean }; }); }catch(e){console.warn(e);} }

  // plus buttons for calculator - open picker for left/right
  document.getElementById('plus-left').addEventListener('click', ()=>{ currentPickerSide='left'; showPicker(); });
  document.getElementById('plus-right').addEventListener('click', ()=>{ currentPickerSide='right'; showPicker(); });

  // init
  try{ createPicker(); restoreTrade(); renderList(); renderThumbs(); updateTotalsAndVerdict(); }catch(e){ console.error('init',e); }

  // expose
  window._skibidi = { unitDatabase, leftItems, rightItems, renderList, renderThumbs, updateTotalsAndVerdict };

})();
</script>
</body>
</html>
