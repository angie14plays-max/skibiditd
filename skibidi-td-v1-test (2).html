<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skibidi TD — Value List + Calculator (v1 test)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* ===== your original CSS, unchanged ===== */
    :root{
      --bg:#050506;
      --card:#0f0f11;
      --panel:#111214;
      --box:#141618;
      --border:#232529;
      --muted:#9aa0a5;
      --text:#ffffff;
      --radius:12px;

      --g-astral: linear-gradient(90deg,#7f00ff,#00ffd5);
      --g-cosmic: linear-gradient(90deg,#b800e6,#6cedf0);
      --g-divine: linear-gradient(90deg,#ff00c8,#2248ff);
      --g-godly: linear-gradient(90deg,#7b00e6,#6367ff);
      --g-exclusive: linear-gradient(90deg,#00d1ff,#4fe0a3);
      --g-mythic: linear-gradient(90deg,#ff6d68,#ffb86b);
      --g-legendary: linear-gradient(90deg,#ffd54a,#ff7a00);
    }

    *{box-sizing:border-box;font-family:"Montserrat",sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
    body{padding:20px;display:flex;flex-direction:column;align-items:center;gap:18px}

    .container{width:100%;max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:12px;align-items:center}

    /* search + menu row */
    .top-row{width:100%;display:flex;align-items:center;gap:12px;justify-content:space-between}
    #search-bar{flex:1;padding:12px 16px;border-radius:22px;background:var(--card);border:1px solid var(--border);color:var(--text);outline:none}
    .menu-btn{width:44px;height:44px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:grid;place-items:center;cursor:pointer}
    .menu-btn .dots{width:6px;height:6px;background:var(--muted);border-radius:50%;box-shadow:0 -10px 0 0 var(--muted),0 10px 0 0 var(--muted)}

    /* menu panel (chrome-like) */
    .menu-panel{position:absolute;right:22px;top:78px;min-width:260px;background:#fff;color:#000;border-radius:10px;box-shadow:0 24px 60px rgba(0,0,0,0.6);border:1px solid rgba(0,0,0,0.06);display:none;z-index:9999;overflow:hidden}
    .menu-section{padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)}
    .menu-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;cursor:pointer}
    .menu-item:hover{background:rgba(0,0,0,0.04)}
    .menu-label{font-weight:700;text-transform:uppercase}

    /* controls row (visible chips) */
    .controls-row { width:100%; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    /* unified button size */
    .chip, .sort-btn {
      padding:12px 20px;
      border-radius:14px;
      font-weight:900;
      text-transform:uppercase;
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
      min-width:120px;
      text-align:center;
      cursor:pointer;
    }
    .chip.active{border-color:#ffd54a;box-shadow:0 10px 40px rgba(0,0,0,0.6);}

    /* layout: centered list */
    .list-root{width:100%;max-width:1200px;display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-top:12px}

    /* unit card */
    .unit-card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.02));border-radius:var(--radius);padding:18px;border:1px solid var(--border);min-height:360px;display:flex;flex-direction:column;justify-content:space-between;overflow:visible}
    /* header area fixed to align cards */
    .card-header{height:190px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
    .unit-title{font-weight:900;text-transform:uppercase;font-size:16px;letter-spacing:0.6px;text-align:center}

    /* portrait frame (rounded square behind circle) */
    .portrait-frame{width:132px;height:132px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.03);position:relative}
    .portrait-circle{width:110px;height:110px;border-radius:50%;background:var(--box);display:flex;align-items:center;justify-content:center;border:3px solid rgba(0,0,0,0.6)}
    .portrait-circle .img{width:98px;height:98px;border-radius:50%;background-size:cover;background-position:center}

    /* rarity halo behind frame */
    .unit-card.rarity-astral .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-astral);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-cosmic .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-cosmic);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-divine .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-divine);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-godly .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-godly);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-exclusive .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-exclusive);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-mythic .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-mythic);z-index:-1;opacity:0.95;filter:blur(8px)}
    .unit-card.rarity-legendary .portrait-frame::before{content:'';position:absolute;inset:-8px;border-radius:22px;background:var(--g-legendary);z-index:-1;opacity:0.95;filter:blur(8px)}

    /* info row */
    .info-row{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px}
    .info-box{min-width:120px;background:var(--panel);border-radius:10px;padding:12px 14px;text-align:center;border:1px solid var(--border)}
    .info-box .label{display:block;color:var(--muted);font-weight:800;font-size:11px;text-transform:uppercase}
    .info-box .value{display:block;font-weight:900;margin-top:6px}

    /* neutral badges kept (no colored gradients) */
    .status-badge,.demand-pill{background:var(--panel);color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:900;text-transform:uppercase;border:1px solid var(--border)}

    /* calculator thumbnails */
    .calc-thumb{width:76px;height:76px;border-radius:10px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid rgba(255,255,255,0.04);background:var(--panel)}
    .calc-thumb .img{width:100%;height:100%;background-size:cover;background-position:center;border-radius:8px}
    .calc-thumb::before{content:'';position:absolute;inset:-6px;border-radius:12px;z-index:-1;opacity:0.98}
    .calc-thumb.rarity-astral::before{background:var(--g-astral)}
    .calc-thumb.rarity-cosmic::before{background:var(--g-cosmic)}
    .calc-thumb.rarity-divine::before{background:var(--g-divine)}
    .calc-thumb.rarity-godly::before{background:var(--g-godly)}
    .calc-thumb.rarity-exclusive::before{background:var(--g-exclusive)}
    .calc-thumb.rarity-mythic::before{background:var(--g-mythic)}
    .calc-thumb.rarity-legendary::before{background:var(--g-legendary)}

    .soap-badge{position:absolute;right:6px;top:6px;padding:4px 6px;border-radius:8px;background:linear-gradient(90deg,#fff7cc,#fff1a8);color:#3b2f00;font-weight:900;font-size:11px;z-index:4}

    /* picker (scrollable on mobile) */
    .picker-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:9999;padding:12px}
    .picker-box{width:100%;max-width:1180px;max-height:90vh;border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.006),rgba(255,255,255,0.003));border:1px solid var(--border);display:flex;gap:12px;overflow:hidden}
    .picker-sidebar{width:160px;display:flex;flex-direction:column;gap:10px;overflow:auto;padding:6px}
    .picker-cat{padding:12px;border-radius:10px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-weight:900;cursor:pointer}
    .picker-cat.active{outline:2px solid rgba(255,255,255,0.03);color:#fff}
    .picker-grid{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,78px);gap:12px}

    @media (max-width:1024px){ .list-root{grid-template-columns:repeat(2,1fr)} .picker-box{flex-direction:column} .picker-sidebar{width:100%;flex-direction:row;overflow:auto} }
    @media (max-width:600px){ .list-root{grid-template-columns:1fr} .card-header{height:170px} .portrait-frame{width:118px;height:118px} }
  </style>

  <!-- Keep original page HTML unchanged -->
</head>
<body>
  <div class="container">
    <div class="top-row" style="position:relative">
      <input id="search-bar" placeholder="Search unit..." aria-label="Search units" />
      <div style="display:flex;gap:12px;align-items:center">
        <div class="menu-btn" id="menu-btn" title="Menu" aria-haspopup="true" aria-expanded="false"><div class="dots" aria-hidden="true"></div></div>
      </div>

      <div class="menu-panel" id="menu-panel" aria-hidden="true">
        <div class="menu-section">
          <div class="menu-item" data-key="calculator"><div class="menu-label">Calculator</div></div>
        </div>
        <div class="menu-section">
          <div class="menu-item" data-key="all"><div class="menu-label">All</div></div>
          <div class="menu-item" data-key="astral"><div class="menu-label">Astral</div></div>
          <div class="menu-item" data-key="cosmic"><div class="menu-label">Cosmic</div></div>
          <div class="menu-item" data-key="divine"><div class="menu-label">Divine</div></div>
          <div class="menu-item" data-key="godly"><div class="menu-label">Godly</div></div>
          <div class="menu-item" data-key="exclusive"><div class="menu-label">Exclusive</div></div>
          <div class="menu-item" data-key="mythic"><div class="menu-label">Mythic</div></div>
          <div class="menu-item" data-key="legendary"><div class="menu-label">Legendary</div></div>
        </div>
      </div>
    </div>

    <div class="controls-row">
      <div class="chip active" data-rarity="all">All</div>
      <div class="chip" data-rarity="astral">Astral</div>
      <div class="chip" data-rarity="cosmic">Cosmic</div>
      <div class="chip" data-rarity="divine">Divine</div>
      <div class="chip" data-rarity="godly">Godly</div>
      <div class="chip" data-rarity="exclusive">Exclusive</div>
      <div class="chip" data-rarity="mythic">Mythic</div>
      <div class="chip" data-rarity="legendary">Legendary</div>
    </div>

    <div style="display:flex;gap:12px">
      <button class="sort-btn active" data-sort="default">Default Sort</button>
      <button class="sort-btn" data-sort="value-desc">High Value</button>
    </div>

    <div id="list-root" class="list-root"></div>

    <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-top:12px" id="pagination">
      <button id="prev-btn" class="chip" style="min-width:120px">Previous</button>
      <div id="page-info" style="color:var(--muted)">Page 1 of 1</div>
      <button id="next-btn" class="chip" style="min-width:120px">Next</button>
    </div>

    <!-- Calculator area (kept in page) -->
    <div id="calculator-root" style="display:block;width:100%;max-width:1200px;margin-top:12px">
      <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;align-items:flex-start">
        <div style="width:46%;min-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.01));padding:18px;border-radius:12px;border:1px solid var(--border)">
          <div style="text-align:center;font-weight:900">YOUR VALUE</div>
          <div style="display:flex;gap:12px;align-items:center;margin:12px 0">
            <div class="picker-cat" style="width:120px;text-align:left;padding:12px;border-radius:10px;background:var(--card);border:1px solid var(--border)">Astral</div>
            <input placeholder="SEARCH UNITS..." style="flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)" />
          </div>
          <div id="left-items" style="display:grid;grid-template-columns:repeat(auto-fill,76px);gap:8px;min-height:120px;border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.02)"></div>
          <div style="text-align:center;margin-top:12px"><span id="left-total" style="padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);color:#000;font-weight:900">TOTAL VALUE: 0</span></div>
        </div>

        <div style="width:46%;min-width:260px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.01));padding:18px;border-radius:12px;border:1px solid var(--border)">
          <div style="text-align:center;font-weight:900">THEIR VALUE</div>
          <div style="display:flex;justify-content:center;margin:12px 0"><button id="plus-right" class="chip" style="min-width:56px;height:56px;border-radius:12px">+</button></div>
          <div id="right-items" style="display:grid;grid-template-columns:repeat(auto-fill,76px);gap:8px;min-height:120px"></div>
          <div style="text-align:center;margin-top:12px"><span id="right-total" style="padding:8px 12px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);color:#000;font-weight:900">TOTAL VALUE: 0</span></div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;margin-top:12px"><div id="verdict-text" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);font-weight:900;color:#6ea0ff">NO ITEMS</div></div>
    </div>

    <!-- Picker + modal containers -->
    <div class="picker-overlay" id="picker-overlay" style="display:none">
      <div class="picker-box">
        <div id="picker-sidebar" class="picker-sidebar"></div>
        <div style="flex:1;display:flex;flex-direction:column;gap:10px">
          <input id="picker-search-input" placeholder="SEARCH UNITS..." style="padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--border);color:var(--text)"/>
          <div id="picker-grid" class="picker-grid"></div>
        </div>
      </div>
    </div>

    <div id="trait-overlay" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:10010"></div>

  </div><!-- container -->

  <script src="skibidi-td-data.js"></script>

  <!-- ===================== Integrated script: adds trait buttons into unit cards + full calculator ===================== -->
  <script>
  (function(){
    'use strict';

    // small helpers
    const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";
    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const parseValue = v => { if (v === 0) return 0; if(!v && v!==0) return 0; let s=String(v).trim().replace(/[\$\€\£\¥\₹]/g,'').replace(/\s+/g,''); const m=s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/); if(m){ let n=parseFloat(m[1].replace(/,/g,''))||0; const sx=m[2]; if(sx){ if(sx.toLowerCase()==='k') n*=1e3; if(sx.toLowerCase()==='m') n*=1e6;} return n;} const f=s.match(/[\d.]+/); return f?parseFloat(f[0].replace(/,/g,'')):0; };
    const abbr = n => { if(!isFinite(n)||n===0) return '0'; if(n>=1e6) return (n/1e6).toFixed(2)+'M+'; if(n>=1e3) return (n/1e3).toFixed(2)+'K'; return Math.round(n).toLocaleString(); };
    const SOAP_SVG_DATAURL = "data:image/svg+xml;utf8," + encodeURIComponent('<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"><rect width="24" height="24" rx="6" fill="#fff"/><path fill="#4b7aff" d="M12 2a3 3 0 0 1 3 3v1h-2V5a1 1 0 0 0-1-1 1 1 0 0 0-1 1v1H9V5a3 3 0 0 1 3-3z"/><circle cx="8" cy="15" r="3" fill="#4b7aff"/><circle cx="16" cy="15" r="3" fill="#4b7aff"/></svg>');

    // Trait icon IDs you provided earlier
    const TRAIT_ICONS = {
      gm: '1vAZZgMrtVNtV3_EGpCmtH01DNSS5NW4H',
      ms: '13nyhqIwm-1w_-6t6imnKz7x9ShownI92',
      sp: '1y2l5qpi5WmFE9cmcMSRZwRijpfos4VYT',
      spd: '1URYMM6bvJyunpdUefQdOnLjS5LyAyblO'
    };

    function iconUrlFor(name){
      if (name === 'clean') return SOAP_SVG_DATAURL;
      if (name === 'gm') return imageProvider + TRAIT_ICONS.gm;
      if (name === 'ms') return imageProvider + TRAIT_ICONS.ms;
      if (name === 'sp') return imageProvider + TRAIT_ICONS.sp;
      if (name === 'spd') return imageProvider + TRAIT_ICONS.spd;
      return '';
    }

    if (typeof unitDatabase === 'undefined') { console.error('unitDatabase missing'); return; }

    // Reuse your existing renderValueList but inject trait buttons
    const listRoot = document.getElementById('list-root');
    const searchInput = document.getElementById('search-bar');
    const tabs = document.getElementById('tabs-container');
    const sortWrap = document.getElementById('sort-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');

    let currentFilter = 'all', searchQuery = '', currentSort = 'default', currentPage = 1;
    const itemsPerPage = 15;
    const rarityOrder = { astral:1, cosmic:2, divine:3, godly:4, exclusive:5, mythic:6, legendary:7 };

    // Calculator internal state (we provide full calculator so it works even if original was removed)
    const LS_KEY = 'skibidi_td_calc_state_v1';
    let leftItems = [], rightItems = [];
    const leftItemsEl = document.getElementById('left-items');
    const rightItemsEl = document.getElementById('right-items');
    const leftTotalEl = document.getElementById('left-total');
    const rightTotalEl = document.getElementById('right-total');
    const verdictText = document.getElementById('verdict-text');
    let currentPickerSide = 'left';

    // small helpers for calculator
    function addToSideLocal(side,key,trait,qty){
      qty = Math.max(1,Math.floor(qty)||1);
      const u = unitDatabase[key];
      const single = (trait && trait!=='normal' && trait!=='clean' && u.traits && u.traits[trait]) ? parseValue(u.traits[trait].value) : parseValue(u.baseStats.value);
      const arr = (side==='left') ? leftItems : rightItems;
      const found = arr.find(x=> x.key===key && String(x.trait)===String(trait));
      if (found) {
        found.qty += qty;
        found.computed = (found.single||single) * found.qty;
      } else {
        const it = { id:`${key}:${trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key, trait, qty, single, computed: single*qty, clean: trait==='clean' };
        arr.push(it);
      }
      persistCalc();
      renderCalcThumbs();
      updateTotals();
    }

    // try to call existing external addToSide when available, else fallback to local
    function addToSideUnified(side,key,trait,qty){
      // Try user-provided functions first (keeps original behavior if present)
      if (window._skibidi && typeof window._skibidi.addToSide === 'function') {
        try { window._skibidi.addToSide(side,key,trait,qty); return; } catch(e){ console.warn(e); }
      }
      if (window._skibidi_calc && typeof window._skibidi_calc.addToSide === 'function') {
        try { window._skibidi_calc.addToSide(side,key,trait,qty); return; } catch(e){ console.warn(e); }
      }
      if (typeof addToSide === 'function') {
        try { addToSide(side,key,trait,qty); return; } catch(e){ console.warn(e); }
      }
      // fallback to local impl
      addToSideLocal(side,key,trait,qty);
    }

    function persistCalc(){ try { localStorage.setItem(LS_KEY, JSON.stringify({left:leftItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty})), right:rightItems.map(i=>({key:i.key,trait:i.trait,qty:i.qty})) })); } catch(e){console.warn(e);} }
    function restoreCalc(){ try { const raw = localStorage.getItem(LS_KEY); if(!raw) return; const p = JSON.parse(raw); leftItems = (p.left||[]).map(it=>{ const u=unitDatabase[it.key]||{}; const single = (it.trait && it.trait!=='normal' && it.trait!=='clean' && u.traits && u.traits[it.trait])?parseValue(u.traits[it.trait].value):parseValue((u.baseStats&&u.baseStats.value)||0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!(it.trait==='clean') }; }); rightItems = (p.right||[]).map(it=>{ const u=unitDatabase[it.key]||{}; const single = (it.trait && it.trait!=='normal' && it.trait!=='clean' && u.traits && u.traits[it.trait])?parseValue(u.traits[it.trait].value):parseValue((u.baseStats&&u.baseStats.value)||0); return { id:`${it.key}:${it.trait}:${Date.now()}:${Math.random().toString(36).slice(2,6)}`, key:it.key, trait:it.trait, qty:Math.max(1,it.qty||1), single, computed: single*(it.qty||1), clean:!!(it.trait==='clean') }; }); } catch(e){ console.warn(e); } }

    function calcThumbHtml(it){
      const u = unitDatabase[it.key]||{};
      const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
      const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-');
      const traitIcon = (it.trait==='clean') ? SOAP_SVG_DATAURL : ( /grand/i.test(it.trait)? imageProvider+TRAIT_ICONS.gm : /master/i.test(it.trait) ? imageProvider+TRAIT_ICONS.ms : /snip/i.test(it.trait)? imageProvider+TRAIT_ICONS.sp : /super/i.test(it.trait) ? imageProvider+TRAIT_ICONS.spd : '' );
      const demand = (u.baseStats && u.baseStats.demand) ? u.baseStats.demand : '';
      const soap = it.clean ? '<div class="soap-badge">SOAP</div>' : '';
      return `<div class="calc-thumb rarity-${rcls}" data-id="${it.id}">
        ${soap}
        <div class="img" style="background-image:${p}"></div>
        ${ traitIcon ? `<img src="${traitIcon}" alt="" style="position:absolute;top:6px;left:6px;width:20px;height:20px;border-radius:4px;"/>` : '' }
        <div style="position:absolute;bottom:6px;right:6px;background:#000;color:#fff;padding:2px 6px;border-radius:8px;font-weight:900">x${it.qty}</div>
        <div style="position:absolute;bottom:6px;left:6px;background:var(--panel);color:#fff;padding:2px 6px;border-radius:8px;font-weight:700;font-size:11px">${esc(demand)}</div>
      </div>`;
    }
    function renderCalcThumbs(){ leftItemsEl.innerHTML = leftItems.map(calcThumbHtml).join(''); rightItemsEl.innerHTML = rightItems.map(calcThumbHtml).join(''); }

    function updateTotals(){
      leftItems.forEach(i=> i.computed = (i.single||0)*(i.qty||1));
      rightItems.forEach(i=> i.computed = (i.single||0)*(i.qty||1));
      const leftSum = leftItems.reduce((s,i)=>s+Number(i.computed||0),0);
      const rightSum = rightItems.reduce((s,i)=>s+Number(i.computed||0),0);
      leftTotalEl.textContent = `TOTAL VALUE: ${abbr(leftSum)}`;
      rightTotalEl.textContent = `TOTAL VALUE: ${abbr(rightSum)}`;
      const FAIR=0.02, SMALL=0.10;
      let verdict='NO ITEMS';
      if (leftSum===0 && rightSum===0) verdict='NO ITEMS';
      else if (Math.abs(leftSum-rightSum) <= Math.max(1,FAIR*Math.max(leftSum,rightSum))) verdict='FAIR';
      else if (leftSum>rightSum){ if (rightSum===0 || leftSum>rightSum*(1+SMALL)) verdict='OVERPAYING'; else verdict='LOSE'; }
      else { if (leftSum===0 || rightSum>leftSum*(1+SMALL)) verdict='UNDERPAYING'; else verdict='WIN'; }
      verdictText.textContent = verdict.toUpperCase();
    }

    // picker + trait modal (preselected trait when clicking trait button)
    const pickerOverlay = document.getElementById('picker-overlay');
    const pickerSidebar = document.getElementById('picker-sidebar');
    const pickerGrid = document.getElementById('picker-grid');
    const pickerSearch = document.getElementById('picker-search-input');
    const traitOverlay = document.getElementById('trait-overlay');

    function createPicker(){
      const cats = ['Astral','Cosmic','Divine','Godly','Exclusive','Mythic','Legendary'];
      pickerSidebar.innerHTML = cats.map(c=>`<div class="picker-cat" data-cat="${c.toLowerCase()}">${c}</div>`).join('');
      const def = pickerSidebar.querySelector('[data-cat="astral"]'); if(def) def.classList.add('active');
      renderPickerGrid('astral','','','astral','');
      pickerSidebar.querySelectorAll('.picker-cat').forEach(btn=>{ btn.addEventListener('click', ()=>{ pickerSidebar.querySelectorAll('.picker-cat').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderPickerGrid(btn.getAttribute('data-cat')||'astral','','',btn.getAttribute('data-cat')||'astral'); }); });
      pickerSearch.value=''; pickerSearch.removeEventListener('input', onPickerSearch); pickerSearch.addEventListener('input', onPickerSearch);
      pickerOverlay.addEventListener('click', ev => { if (ev.target===pickerOverlay) hidePicker(); });
    }
    function onPickerSearch(e){ const active = pickerSidebar.querySelector('.picker-cat.active'); const cat = active?active.getAttribute('data-cat'):'astral'; renderPickerGrid(cat,'','',cat,e.target.value||''); }
    function renderPickerGrid(side,trait,qty,category,q){ category=(category||'astral').toLowerCase(); q=(q||'').toLowerCase(); const keys = unitKeys.filter(k=>{ const u=unitDatabase[k]; if(!u) return false; if((u.rarity||'').toLowerCase()!==category) return false; if(q && !(u.name||'').toLowerCase().includes(q)) return false; return true; }); if(!keys.length){ pickerGrid.innerHTML=''; return; } pickerGrid.innerHTML = keys.map(k=>{ const u=unitDatabase[k]; const p = u.unitId ? `url('${imageProvider}${u.unitId}')` : ''; const rcls=(u.rarity||'').toLowerCase().replace(/\s+/g,'-'); return `<div class="picker-thumb rarity-${rcls}" data-key="${k}"><div style="width:68px;height:68px;border-radius:8px;background-image:${p};background-size:cover;background-position:center"></div></div>`; }).join(''); pickerGrid.querySelectorAll('.picker-thumb').forEach(t=>{ t.removeEventListener('click', onPickerClick); t.addEventListener('click', onPickerClick); }); }
    function showPicker(){ pickerOverlay.style.display='flex'; document.body.style.overflow='hidden'; }
    function hidePicker(){ pickerOverlay.style.display='none'; document.body.style.overflow=''; }
    function onPickerClick(e){ const key = e.currentTarget.getAttribute('data-key'); if(!key) return; openTraitModalForKey(key); }

    // modal opened preselected to trait param (if provided)
    function openTraitModalForKey(key, preTrait){
      const u = unitDatabase[key]; if(!u) return;
      const base = [{id:'clean',label:'Clean'},{id:'normal',label:'Normal'}];
      const extra = u.traits ? Object.keys(u.traits) : [];
      const all = base.concat(extra.map(t=>({id:t,label:t})));
      // build icons and radios
      const radios = all.map(t=>{
        const label = t.label;
        const id = 'sk_trait_'+Math.random().toString(36).slice(2,8);
        const checked = (preTrait && preTrait===t.id) || (!preTrait && t.id==='normal') ? 'checked' : '';
        const icon = (t.id==='clean') ? SOAP_SVG_DATAURL : ( /grand/i.test(t.id) ? imageProvider+TRAIT_ICONS.gm : /master/i.test(t.id) ? imageProvider+TRAIT_ICONS.ms : /snip/i.test(t.id) ? imageProvider+TRAIT_ICONS.sp : /super/i.test(t.id) ? imageProvider+TRAIT_ICONS.spd : '' );
        const valueText = (u.traits && u.traits[t.id] && u.traits[t.id].value) ? u.traits[t.id].value : u.baseStats.value;
        return `<label style="display:flex;align-items:center;gap:8px;margin:6px 8px;cursor:pointer"><input type="radio" name="sk_trait" value="${esc(t.id)}" ${checked}/> ${ icon ? `<img src="${icon}" style="width:20px;height:20px;border-radius:4px;object-fit:cover" />` : '' } <span style="font-weight:900;color:#fff">${esc(label)} - <span style="color:#ffd">${esc(valueText)}</span></span></label>`;
      }).join('');
      const demand = (u.baseStats && u.baseStats.demand) ? u.baseStats.demand : '';
      traitOverlay.innerHTML = `<div style="width:100%;max-width:520px;padding:14px;background:var(--card);border-radius:10px;border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:900;font-size:18px;text-transform:uppercase;color:#fff">Enter Quantity</div>
          <button id="sk_close" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer">×</button>
        </div>
        <div style="margin-bottom:10px">
          <input id="sk_qty" type="number" min="1" value="1" placeholder="Quantity" style="width:100%;padding:12px;border-radius:10px;border:2px solid #552aa8;background:#000;color:#fff;font-weight:900"/>
        </div>
        <div style="font-weight:900;color:#fff;margin-bottom:8px">Traits</div>
        <div id="sk_traits" style="margin-bottom:12px">${radios}</div>
        <div style="margin-bottom:12px;color:#ddd;font-weight:700">Demand: <span id="sk_demand">${esc(demand)}</span></div>
        <div style="display:flex;justify-content:center"><button id="sk_add" style="padding:12px 18px;border-radius:10px;background:linear-gradient(90deg,#7b00e6,#ff2d6f);border:2px solid rgba(255,255,255,0.04);color:#000;font-weight:900;cursor:pointer">Add</button></div>
      </div>`;
      traitOverlay.style.display='flex'; traitOverlay.style.alignItems='center'; traitOverlay.style.justifyContent='center';
      document.getElementById('sk_close').addEventListener('click', ()=> traitOverlay.style.display='none');
      traitOverlay.addEventListener('click', function out(e){ if(e.target===traitOverlay){ traitOverlay.style.display='none'; traitOverlay.removeEventListener('click', out); }});
      document.getElementById('sk_add').addEventListener('click', ()=>{
        const qty = Number(document.getElementById('sk_qty').value) || 1;
        const sel = traitOverlay.querySelector('input[name="sk_trait"]:checked');
        const trait = sel ? sel.value : 'normal';
        addToSideUnified(currentPickerSide, key, trait, qty);
        traitOverlay.style.display='none';
      });
    }

    // ===== trait buttons inside unit card + render function (uses your original render but modifies) =====
    const unitKeys = Object.keys(unitDatabase).sort((a,b)=> (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||''));
    function formatStatusClass(status){ return String(status||'').toLowerCase().replace(/\s+/g,'-'); }

    function buildTraitButtonsForUnit(key, unit){
      // show Clean + Normal + unit.traits keys (if any). Each button shows the trait value (trait.value or baseStats.value)
      const traits = ['clean','normal'];
      if (unit.traits) traits.push(...Object.keys(unit.traits));
      // create buttons with rarity-accent border
      const rarity = (unit.rarity||'').toLowerCase();
      const color = getComputedStyle(document.documentElement).getPropertyValue('--g-'+rarity) || 'transparent';
      return traits.map(t=>{
        const display = (t==='clean') ? 'Clean' : (t==='normal') ? 'Normal' : t;
        const value = (unit.traits && unit.traits[t] && unit.traits[t].value) ? unit.traits[t].value : unit.baseStats.value;
        // clicking opens modal preselected to this trait (option B)
        return `<button class="trait-btn" data-unit="${key}" data-trait="${esc(t)}" style="margin:6px;padding:8px 10px;border-radius:10px;border:2px solid rgba(255,255,255,0.03);background:var(--card);color:#fff;font-weight:900;cursor:pointer">
          <span style="display:inline-block;font-size:12px;margin-right:8px">${esc(display)}</span>
          <span style="background:transparent;color:#ffd;font-weight:900">${esc(value)}</span>
        </button>`;
      }).join('');
    }

    function renderValueList(){
      const keys = Object.keys(unitDatabase).filter(k=>{
        const u = unitDatabase[k];
        const r = (u.rarity||'').toLowerCase();
        if (currentFilter !== 'all' && r !== currentFilter) return false;
        if (searchQuery && !(u.name||'').toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
      });

      keys.sort((a,b)=>{
        if (currentSort === 'value-desc') return parseValue(unitDatabase[b].baseStats.value) - parseValue(unitDatabase[a].baseStats.value);
        const wa = rarityOrder[(unitDatabase[a].rarity||'').toLowerCase()]||99;
        const wb = rarityOrder[(unitDatabase[b].rarity||'').toLowerCase()]||99;
        if (wa !== wb) return wa - wb;
        return (unitDatabase[a].name||'').localeCompare(unitDatabase[b].name||'');
      });

      const totalPages = Math.max(1, Math.ceil(keys.length/itemsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const startIndex = (currentPage-1)*itemsPerPage;
      const pageKeys = keys.slice(startIndex, startIndex+itemsPerPage);

      pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      listRoot.innerHTML = pageKeys.map(k=>{
        const u = unitDatabase[k];
        const portrait = u.unitId ? `url('${imageProvider}${u.unitId}')` : '';
        const rcls = (u.rarity||'').toLowerCase().replace(/\s+/g,'-');
        const stClass = formatStatusClass(u.baseStats.status);
        const second = u.secondEdition && String(u.secondEdition).toLowerCase()==='yes' ? `<div class="second-edition-tag">2nd Edition</div>` : '';
        const traitButtonsHtml = buildTraitButtonsForUnit(k,u);
        return `
          <div class="unit-card ${rcls}" data-unit="${k}">
            <div class="card-header">
              <div class="unit-title">${esc(u.name)}</div>
              <div class="portrait-frame ${rcls}">
                <div class="portrait-circle ${rcls}">
                  <div class="img" style="background-image:${portrait}"></div>
                </div>
              </div>
              ${second}
            </div>

            <div style="display:flex;flex-direction:column;gap:10px;align-items:center">
              <div style="width:100%;display:flex;justify-content:center;flex-wrap:wrap">${traitButtonsHtml}</div>
            </div>

            <div class="info-row">
              <div class="info-box">
                <div class="label">Value</div>
                <div class="val val-value highlight-gold">${esc(u.baseStats.value)}</div>
              </div>
              <div class="info-box">
                <div class="label">Status</div>
                <div class="val val-status status-${stClass}">${esc(u.baseStats.status)}</div>
              </div>
              <div class="info-box">
                <div class="label">Demand</div>
                <div class="val val-demand highlight-purple">${esc(u.baseStats.demand)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      // after rendering, wire trait buttons to open preselected modal
      document.querySelectorAll('.trait-btn').forEach(btn=>{
        btn.removeEventListener('click', onTraitBtnClick);
        btn.addEventListener('click', onTraitBtnClick);
      });
    }

    function onTraitBtnClick(e){
      const btn = e.currentTarget;
      const unitKey = btn.getAttribute('data-unit');
      const trait = btn.getAttribute('data-trait');
      currentPickerSide = (window.currentPickerSide) ? window.currentPickerSide : currentPickerSide;
      openTraitModalForKey(unitKey, trait); // opens modal preselected per Option B
    }

    // attach controls
    document.getElementById('search-bar').addEventListener('input', (e)=>{ searchQuery = e.target.value || ''; currentPage = 1; renderValueList(); });
    document.getElementById('tabs-container').addEventListener('click', (e)=>{ if(e.target.classList.contains('tab-btn')){ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentFilter = e.target.getAttribute('data-rarity'); currentPage=1; renderValueList(); }});
    document.getElementById('sort-container').addEventListener('click', (e)=>{ if(e.target.classList.contains('sort-btn')){ document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); currentSort = e.target.getAttribute('data-sort'); currentPage=1; renderValueList(); }});
    prevBtn.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderValueList(); window.scrollTo({top:0,behavior:'smooth'}); }});
    nextBtn.addEventListener('click', ()=>{ const filteredTotal = Object.keys(unitDatabase).filter(key=>{ const u=unitDatabase[key]; return (currentFilter==='all' || u.rarity===currentFilter) && u.name.toLowerCase().includes(searchQuery.toLowerCase()); }).length; const maxPage = Math.ceil(filteredTotal/itemsPerPage); if(currentPage<maxPage){ currentPage++; renderValueList(); window.scrollTo({top:0,behavior:'smooth'}); }});

    // Initialize page list and calculator
    (function init(){
      try { restoreCalc(); renderValueList(); renderCalcThumbs(); updateTotals(); } catch(e){ console.error(e); }
    })();

    // expose for debug
    window._skibidi_calc = { addToSide: addToSideUnified, leftItems, rightItems, renderCalcThumbs, updateTotals };

  })();
  </script>

</body>
</html>
