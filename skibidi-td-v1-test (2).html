<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
  <title>Skibidi TD Value List (fixed)</title>
  <style>
    :root {
      --bg-page: #000000;
      --card-bg: #111111;
      --box-bg: #1a1a1a;
      --border-solid: #333333;
      --text-main: #ffffff;
      --text-dim: #777777;
      --gold: #facc15;
      --purple: #a855f7;

      --rising: #22c55e;
      --stable: #f97316;
      --dropping: #ec4899;
      --overpaid: #facc15;
      --underpaid: #ef4444;
      --hyped: #3b82f6;
      --recovering: #555555;
      --unstable: #9d174d;

      --grad-astral: linear-gradient(60deg, #640081, #7e00a5, #154af0, #00cd82, #11ff46);
      --grad-cosmic: linear-gradient(80deg, #b800e6, #6cedf0);
      --grad-divine: linear-gradient(180deg, #c400cf, #2248ff);
      --grad-godly: linear-gradient(180deg, #7b00e6, #6367ff);
      --grad-exclusive: linear-gradient(180deg, #2e7dff, #2be7f6);
      --grad-mythic: linear-gradient(180deg, #ff6d68, #cc1d1b);
      --grad-legendary: linear-gradient(180deg, #f5a623, #d48c00);
    }

    * { font-family: 'Montserrat', sans-serif; letter-spacing: 0.5px; box-sizing: border-box; }

    body {
      background-color: var(--bg-page);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .status-rising { color: var(--rising); }
    .status-stable { color: var(--stable); }
    .status-dropping { color: var(--dropping); }
    .status-overpaid { color: var(--overpaid); }
    .status-underpaid { color: var(--underpaid); }
    .status-hyped { color: var(--hyped); }
    .status-recovering { color: var(--recovering); }
    .status-unstable { color: var(--unstable); }

    .rarity-astral { --theme: var(--grad-astral); }
    .rarity-cosmic { --theme: var(--grad-cosmic); }
    .rarity-divine { --theme: var(--grad-divine); }
    .rarity-godly { --theme: var(--grad-godly); }
    .rarity-exclusive { --theme: var(--grad-exclusive); }
    .rarity-mythic { --theme: var(--grad-mythic); }
    .rarity-legendary { --theme: var(--grad-legendary); }

    .controls-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #search-bar {
      width: 100%;
      padding: 15px 20px;
      background: var(--card-bg);
      border: 2px solid var(--border-solid);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }
    #search-bar:focus { border-color: var(--gold); }

    .tabs-wrapper, .sort-wrapper {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .tab-btn, .sort-btn {
      background: var(--card-bg);
      border: 2px solid var(--border-solid);
      color: var(--text-dim);
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 12px;
      transition: 0.3s;
      border-radius: 8px;
    }
    .tab-btn:hover, .tab-btn.active, .sort-btn:hover, .sort-btn.active {
      color: white; border-color: var(--gold);
    }

    .list-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
      max-width: 1200px;
      width: 100%;
    }

    .unit-card {
      background-color: var(--card-bg);
      border: 2px solid var(--border-solid);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .header-section { min-height: 60px; margin-bottom: 10px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .unit-title { font-size:16px; font-weight:900; text-transform:uppercase; line-height:1.1; }
    .second-edition-tag { font-size:10px; font-weight:700; color:var(--gold); text-transform:uppercase; margin-top:4px; letter-spacing:1px; }

    .card-body { display:flex; align-items:center; justify-content:space-between; margin-bottom:25px; gap:10px; }
    .buff-column { display:flex; flex-direction:column; gap:12px; }

    .icon-slot {
      width:42px; height:42px; background-color:var(--box-bg);
      border:2px solid var(--border-solid); border-radius:50%; display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative; cursor:pointer; transition:0.3s; filter:grayscale(1); opacity:.2;
    }
    .icon-slot:hover { opacity:0.6; }
    .icon-slot.active { filter:grayscale(0); opacity:1; border-color:var(--gold); }

    .icon-img { width:75%; height:75%; background-image:var(--asset-path); background-size:contain; background-repeat:no-repeat; background-position:center; }

    .effect-overlay { position:absolute; inset:0; pointer-events:none; background:linear-gradient(90deg,#ff000080,#ffff0080,#00ff0080,#0000ff80,#ff000080); background-size:200% auto; display:none;
      -webkit-mask: var(--asset-path) center/75% no-repeat; mask: var(--asset-path) center/75% no-repeat; }
    .icon-slot.active .effect-overlay { display:block; animation:move-overlay 3s linear infinite; }
    @keyframes move-overlay { to { background-position: -200% 50%; } }

    .portrait-frame {
      width:120px; height:120px; border-radius:50%; background:var(--theme); border:3px solid #000;
      display:flex; justify-content:center; align-items:center; cursor:pointer; flex-shrink:0;
    }
    .unit-image { width:130px; height:130px; background-image:var(--unit-img); background-size:cover; background-position:center; }

    .data-table { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
    .data-cell { background-color:var(--box-bg); border:1px solid var(--border-solid); padding:10px 2px; border-radius:8px; }
    .label { display:block; color:var(--text-dim); font-size:9px; font-weight:bold; text-transform:uppercase; margin-bottom:2px; }
    .val { font-size:12px; font-weight:bold; transition:0.3s; }
    .highlight-gold { color:var(--gold); }
    .highlight-purple { color:var(--purple); }

    .pagination-container { margin-top:40px; display:flex; gap:10px; align-items:center; justify-content:center; padding-bottom:40px; }
    .pagination-btn { background:var(--card-bg); border:1px solid var(--border-solid); color:white; padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s; }
    .pagination-btn:hover:not(:disabled) { border-color:var(--gold); background:var(--box-bg); }
    .pagination-btn:disabled { opacity:0.3; cursor:not-allowed; }
    .page-info { font-weight:bold; font-size:14px; color:var(--text-dim); }

    @media (max-width:1024px) { .list-container { grid-template-columns: repeat(2,1fr); } }
    @media (max-width:600px) { .list-container { grid-template-columns: 1fr; } .portrait-frame { width:90px; height:90px; } .unit-image { width:100px; height:100px; } }
  </style>
</head>
<body>
  <div class="controls-container">
    <input type="text" id="search-bar" placeholder="Search unit...">

    <div class="tabs-wrapper" id="tabs-container">
      <button class="tab-btn active" data-rarity="all">All</button>
      <button class="tab-btn" data-rarity="astral">Astral</button>
      <button class="tab-btn" data-rarity="cosmic">Cosmic</button>
      <button class="tab-btn" data-rarity="divine">Divine</button>
      <button class="tab-btn" data-rarity="godly">Godly</button>
      <button class="tab-btn" data-rarity="exclusive">Exclusive</button>
      <button class="tab-btn" data-rarity="mythic">Mythic</button>
      <button class="tab-btn" data-rarity="legendary">Legendary</button>
    </div>

    <div class="sort-wrapper" id="sort-container">
      <button class="sort-btn active" data-sort="default">Default Sort</button>
      <button class="sort-btn" data-sort="value-desc">High Value</button>
    </div>
  </div>

  <div id="list-root" class="list-container"></div>

  <div class="pagination-container">
    <button class="pagination-btn" id="prev-btn">Previous</button>
    <span class="page-info" id="page-info">Page 1 of 1</span>
    <button class="pagination-btn" id="next-btn">Next</button>
  </div>

  <!-- Your data file should define `unitDatabase` as a global object -->
  <script src="skibidi-td-data.js"></script>

  <!-- Robust script (replaces the inline script you were using). 
       - Waits for DOMContentLoaded
       - Validates unitDatabase
       - Implements rarity ordering exactly: astral, cosmic, godly, divine, mythic, legendary
       - parseValue handles K=1,000 and M=1,000,000 only when the entire value matches number+suffix
  -->
  <script>
  (function () {
    // Helper overlay for fatal errors
    function showFatal(message) {
      console.error(message);
      let overlay = document.getElementById('debug-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'debug-overlay';
        Object.assign(overlay.style, {
          position: 'fixed', left: 0, right: 0, top: 0, padding: '12px',
          background: '#b91c1c', color: 'white', zIndex: 99999, fontFamily: 'sans-serif',
          fontSize: '14px', textAlign: 'center'
        });
        document.body.appendChild(overlay);
      }
      overlay.textContent = message;
    }

    // parseValue: recognizes "1,234", "1.2K", "3M". K=1,000 M=1,000,000.
    // Suffix recognized only if the entire trimmed string matches the pattern.
    function parseValue(valString) {
      if (valString === 0) return 0;
      if (!valString && valString !== 0) return 0;
      let s = String(valString).trim();
      s = s.replace(/[\$\€\£\¥\₹]/g, '').replace(/\s+/g, '');
      const fullMatch = s.match(/^([\d,]+(?:\.\d+)?)([kKmM])?$/);
      if (fullMatch) {
        let numPart = fullMatch[1].replace(/,/g, '');
        let num = parseFloat(numPart) || 0;
        const suffix = fullMatch[2];
        if (suffix) {
          const sfx = suffix.toLowerCase();
          if (sfx === 'k') num *= 1e3;
          else if (sfx === 'm') num *= 1e6;
        }
        return num;
      }
      // fallback (tolerant): pull first numeric sequence
      const numericMatch = s.match(/[\d.]+/);
      return numericMatch ? parseFloat(numericMatch[0].replace(/,/g, '')) : 0;
    }
    // expose for console testing
    window.parseValue = parseValue;

    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof unitDatabase === 'undefined') {
          showFatal('Error: unitDatabase is not defined. Make sure skibidi-td-data.js is loaded and defines a global "unitDatabase". Check DevTools Console for script load errors.');
          return;
        }
        if (!document.getElementById('list-root')) {
          showFatal('Error: DOM element #list-root not found. Ensure this script runs after the HTML markup.');
          return;
        }

        const imageProvider = "https://corsproxy.io/?https://drive.google.com/thumbnail?id=";
        let currentFilter = 'all';
        let searchQuery = '';
        let currentSort = 'default';
        let currentPage = 1;
        const itemsPerPage = 15;

        // Rarity order EXACT as requested:
        // astral, cosmic, godly, divine, mythic, legendary
        const rarityOrder = {
          'astral': 1,
          'cosmic': 2,
          'godly': 3,
          'divine': 4,
          'mythic': 5,
          'legendary': 6,
          // anything else after the above
          'exclusive': 99
        };

        const traitsMeta = {
          grandmaster: { id: "1C1TJwQXNqvM0r9g32fq5_j3r6g-B01DF", label: "Grandmaster" },
          master: { id: "1oaTPE4cr2UyiHDX_nDo41efOyUboWoMV", label: "Master" },
          superPayday: { id: "1T1DtpHB_cf4xx1ynNjjzOWXzCeC_bAbk", label: "Super Payday" },
          sniper: { id: "1Y4AdKn1XXEKxVMRgzZYANJLbjRuuHobJ", label: "Sniper" }
        };

        const formatStatusClass = (status) => (status || '').toLowerCase().replace(/\s+/g, '-');

        function updateUnitStats(unitKey, traitKey) {
          const unit = unitDatabase[unitKey];
          const card = document.querySelector(`[data-unit="${unitKey}"]`);
          if (!unit || !card) return;
          const stats = traitKey ? unit.traits[traitKey] : unit.baseStats;
          const valueEl = card.querySelector('.val-value');
          const demandEl = card.querySelector('.val-demand');
          const statusEl = card.querySelector('.val-status');

          if (valueEl) valueEl.innerText = stats.value;
          if (demandEl) demandEl.innerText = stats.demand;
          if (statusEl) {
            statusEl.innerText = stats.status;
            statusEl.className = `val val-status status-${formatStatusClass(stats.status)}`;
          }

          card.querySelectorAll('.icon-slot').forEach(slot => {
            slot.classList.remove('active');
            if (slot.getAttribute('data-trait') === traitKey) slot.classList.add('active');
          });
        }
        // expose global for onclick handlers inside generated markup
        window.updateUnitStats = updateUnitStats;

        function buildTraitIcon(traitKey, unitKey) {
          const meta = traitsMeta[traitKey];
          if (!meta) return '';
          const imgPath = `url('${imageProvider}${meta.id}')`;
          // note: updateUnitStats is globally available
          return `
            <div class="icon-slot" data-trait="${traitKey}" title="${meta.label}" onclick="updateUnitStats('${unitKey}', '${traitKey}')">
              <div class="icon-img" style="--asset-path: ${imgPath}"></div>
              <div class="effect-overlay" style="--asset-path: ${imgPath}"></div>
            </div>`;
        }

        function renderValueList() {
          try {
            const root = document.getElementById('list-root');
            if (!root) throw new Error('#list-root missing');
            let filteredKeys = Object.keys(unitDatabase).filter(key => {
              const unit = unitDatabase[key];
              const uRarity = (unit.rarity || '').toLowerCase();
              const matchesRarity = currentFilter === 'all' || uRarity === currentFilter;
              const matchesSearch = (unit.name || '').toLowerCase().includes(searchQuery.toLowerCase());
              return matchesRarity && matchesSearch;
            });

            filteredKeys.sort((a, b) => {
              const unitA = unitDatabase[a];
              const unitB = unitDatabase[b];

              if (currentSort === 'value-desc') {
                return parseValue(unitB.baseStats.value) - parseValue(unitA.baseStats.value);
              } else {
                const weightA = rarityOrder[(unitA.rarity || '').toLowerCase()] || 999;
                const weightB = rarityOrder[(unitB.rarity || '').toLowerCase()] || 999;
                if (weightA !== weightB) return weightA - weightB;
                return (unitA.name || '').localeCompare(unitB.name || '');
              }
            });

            const totalPages = Math.max(1, Math.ceil(filteredKeys.length / itemsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedKeys = filteredKeys.slice(startIndex, startIndex + itemsPerPage);

            const pageInfoEl = document.getElementById('page-info');
            if (pageInfoEl) pageInfoEl.innerText = `Page ${currentPage} of ${totalPages}`;
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages;

            root.innerHTML = paginatedKeys.map(key => {
              const unit = unitDatabase[key];
              const portraitUrl = `url('${imageProvider}${unit.unitId}')`;
              const statusClass = formatStatusClass(unit.baseStats.status);
              const isSecondEdition = unit.secondEdition && unit.secondEdition.toLowerCase() === "yes";
              const editionSub = isSecondEdition ? `<div class="second-edition-tag">2nd Edition</div>` : '';
              const raritySlug = (unit.rarity || '').toLowerCase();

              return `
                <div class="unit-card rarity-${raritySlug}" data-unit="${key}">
                  <div class="header-section">
                    <div class="unit-title">${unit.name}</div>
                    ${editionSub}
                  </div>
                  <div class="card-body">
                    <div class="buff-column">
                      ${buildTraitIcon('grandmaster', key)}
                      ${buildTraitIcon('master', key)}
                    </div>
                    <div class="portrait-frame" onclick="updateUnitStats('${key}', null)" title="Reset to Base Stats">
                      <div class="unit-image" style="--unit-img: ${portraitUrl}"></div>
                    </div>
                    <div class="buff-column">
                      ${buildTraitIcon('superPayday', key)}
                      ${buildTraitIcon('sniper', key)}
                    </div>
                  </div>
                  <div class="data-table">
                    <div class="data-cell">
                      <span class="label">Value</span>
                      <span class="val val-value highlight-gold">${unit.baseStats.value}</span>
                    </div>
                    <div class="data-cell">
                      <span class="label">Status</span>
                      <span class="val val-status status-${statusClass}">${unit.baseStats.status}</span>
                    </div>
                    <div class="data-cell">
                      <span class="label">Demand</span>
                      <span class="val val-demand highlight-purple">${unit.baseStats.demand}</span>
                    </div>
                  </div>
                </div>`;
            }).join('');
          } catch (err) {
            console.error('renderValueList error:', err);
            showFatal('A runtime error occurred while rendering the list. Check the console for details.');
          }
        }

        // Wire UI (only if elements exist)
        const searchBar = document.getElementById('search-bar');
        if (searchBar) {
          searchBar.addEventListener('input', (e) => {
            searchQuery = e.target.value || '';
            currentPage = 1;
            renderValueList();
          });
        }

        const tabsContainer = document.getElementById('tabs-container');
        if (tabsContainer) {
          tabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
              document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
              e.target.classList.add('active');
              currentFilter = e.target.getAttribute('data-rarity') || 'all';
              currentPage = 1;
              renderValueList();
            }
          });
        }

        const sortContainer = document.getElementById('sort-container');
        if (sortContainer) {
          sortContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('sort-btn')) {
              document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
              e.target.classList.add('active');
              currentSort = e.target.getAttribute('data-sort') || 'default';
              currentPage = 1;
              renderValueList();
            }
          });
        }

        const prevBtn = document.getElementById('prev-btn');
        if (prevBtn) prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderValueList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });

        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) nextBtn.addEventListener('click', () => {
          const filteredTotal = Object.keys(unitDatabase).filter(key => {
            const u = unitDatabase[key];
            return (currentFilter === 'all' || (u.rarity || '').toLowerCase() === currentFilter) &&
                   (u.name || '').toLowerCase().includes(searchQuery.toLowerCase());
          }).length;
          const maxPage = Math.ceil(filteredTotal / itemsPerPage) || 1;
          if (currentPage < maxPage) {
            currentPage++;
            renderValueList();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });

        // quick parseValue tests in console
        console.groupCollapsed('parseValue tests (should show numeric values)');
        console.log('"1.2K" =>', parseValue('1.2K')); // 1200
        console.log('"3M" =>', parseValue('3M'));     // 3000000
        console.log('"12,345" =>', parseValue('12,345')); // 12345
        console.groupEnd();

        // initial render
        renderValueList();

      } catch (err) {
        console.error('Initialization error:', err);
        showFatal('A fatal error occurred during initialization. See console.');
      }
    });
  })();
  </script>
</body>
</html>
